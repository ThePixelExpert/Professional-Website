---
phase: 01-local-development-environment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/config.toml
  - contact-backend/src/config/supabase.js
  - contact-backend/package.json
autonomous: true

must_haves:
  truths:
    - "Developer can run `npx supabase init` and see supabase/ directory created"
    - "Developer can import supabase client in backend code without errors"
    - "Developer can run a simple query to verify client connects to local Supabase"
  artifacts:
    - path: "supabase/config.toml"
      provides: "Supabase CLI configuration"
      contains: "project_id"
    - path: "contact-backend/src/config/supabase.js"
      provides: "Supabase client initialization"
      exports: ["supabase", "supabaseAdmin"]
    - path: "contact-backend/package.json"
      provides: "Project dependencies"
      contains: "@supabase/supabase-js"
  key_links:
    - from: "contact-backend/src/config/supabase.js"
      to: "@supabase/supabase-js"
      via: "import { createClient }"
      pattern: "createClient.*supabase"
    - from: "contact-backend/src/config/supabase.js"
      to: "local Supabase instance"
      via: "smoke test query"
      pattern: "supabase\\.from\\(|supabase\\.rpc\\("
---

<objective>
Initialize Supabase CLI and create the Supabase client configuration module.

Purpose: Establish the foundation for local Supabase development by setting up CLI tooling and the JavaScript client that backend routes will use.

Output:
- `supabase/` directory with CLI configuration
- `contact-backend/src/config/supabase.js` client module
- `@supabase/supabase-js` dependency installed
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-local-development-environment/01-RESEARCH.md
@contact-backend/package.json
@contact-backend/database.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Supabase CLI and install dependencies</name>
  <files>
    supabase/config.toml
    contact-backend/package.json
  </files>
  <action>
1. Install Supabase CLI as dev dependency and Supabase JS client:
   ```bash
   cd contact-backend
   npm install @supabase/supabase-js
   npm install --save-dev supabase
   ```

2. Initialize Supabase in the project root (NOT in contact-backend):
   ```bash
   cd /home/logan/Projects/Professional-Website
   npx supabase init
   ```
   This creates `supabase/` directory with `config.toml`.

3. Verify the supabase directory structure exists:
   - `supabase/config.toml`
   - `supabase/migrations/` (empty initially)
   - `supabase/seed.sql` (empty initially)

4. Edit `supabase/config.toml` to set a meaningful project_id:
   - Change `project_id = "..."` to `project_id = "edwards-engineering"`
   - Keep all other defaults (port 54323, etc.)

Note: Do NOT run `supabase start` yet - that requires Docker and is for Phase 1 verification, not setup.
  </action>
  <verify>
    - `ls supabase/config.toml` exists
    - `grep "project_id" supabase/config.toml` shows "edwards-engineering"
    - `grep "@supabase/supabase-js" contact-backend/package.json` shows the dependency
  </verify>
  <done>
    - Supabase CLI initialized with config.toml in project root
    - @supabase/supabase-js installed in contact-backend
    - supabase CLI installed as dev dependency
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase client configuration module</name>
  <files>
    contact-backend/src/config/supabase.js
  </files>
  <action>
1. Create the `contact-backend/src/` directory structure if it doesn't exist:
   ```bash
   mkdir -p contact-backend/src/config
   ```

2. Create `contact-backend/src/config/supabase.js` with the following content:

```javascript
// Supabase client configuration
// Supports both local development (CLI) and production (self-hosted)
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.SUPABASE_URL
const supabaseAnonKey = process.env.SUPABASE_ANON_KEY
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY

// Validate required environment variables
if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error(
    'Missing Supabase environment variables. ' +
    'Ensure SUPABASE_URL and SUPABASE_ANON_KEY are set in .env'
  )
}

// Public client - uses anon key, respects RLS policies
// Use this for operations that should respect row-level security
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: false  // Server-side: no localStorage available
  }
})

// Admin client - uses service_role key, bypasses RLS
// Use this ONLY for admin operations that need full database access
// NEVER expose this client to frontend or pass service_role key to browser
export const supabaseAdmin = supabaseServiceKey
  ? createClient(supabaseUrl, supabaseServiceKey, {
      auth: {
        autoRefreshToken: false,
        persistSession: false
      }
    })
  : null

// Helper to check if admin client is available
export function hasAdminClient() {
  return supabaseAdmin !== null
}

// Export URL for health checks
export const supabaseConfig = {
  url: supabaseUrl,
  hasServiceRole: !!supabaseServiceKey
}
```

3. Since the existing backend uses CommonJS (`require`), also create a CommonJS-compatible version OR update the package.json to use ES modules. Given the existing codebase uses `require()`, create a CommonJS version instead:

```javascript
// contact-backend/src/config/supabase.js (CommonJS version)
const { createClient } = require('@supabase/supabase-js')

const supabaseUrl = process.env.SUPABASE_URL
const supabaseAnonKey = process.env.SUPABASE_ANON_KEY
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY

// Validate required environment variables
if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error(
    'Missing Supabase environment variables. ' +
    'Ensure SUPABASE_URL and SUPABASE_ANON_KEY are set in .env'
  )
}

// Public client - uses anon key, respects RLS policies
const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: false
  }
})

// Admin client - uses service_role key, bypasses RLS
const supabaseAdmin = supabaseServiceKey
  ? createClient(supabaseUrl, supabaseServiceKey, {
      auth: {
        autoRefreshToken: false,
        persistSession: false
      }
    })
  : null

function hasAdminClient() {
  return supabaseAdmin !== null
}

const supabaseConfig = {
  url: supabaseUrl,
  hasServiceRole: !!supabaseServiceKey
}

module.exports = {
  supabase,
  supabaseAdmin,
  hasAdminClient,
  supabaseConfig
}
```

Use the CommonJS version since the existing server.js uses `require()`.
  </action>
  <verify>
    - `ls contact-backend/src/config/supabase.js` exists
    - `grep "createClient" contact-backend/src/config/supabase.js` shows import
    - `grep "module.exports" contact-backend/src/config/supabase.js` shows exports
  </verify>
  <done>
    - Supabase client module created with both public and admin clients
    - Module uses CommonJS to match existing codebase
    - Environment variable validation included
    - persistSession: false set for server-side usage
  </done>
</task>

<task type="auto">
  <name>Task 3: Create smoke test script to verify client wiring</name>
  <files>
    contact-backend/scripts/test-supabase-connection.js
  </files>
  <action>
1. Create `contact-backend/scripts/` directory if it doesn't exist:
   ```bash
   mkdir -p contact-backend/scripts
   ```

2. Create `contact-backend/scripts/test-supabase-connection.js`:

```javascript
#!/usr/bin/env node
/**
 * Smoke test script to verify Supabase client configuration
 * Run with: node scripts/test-supabase-connection.js
 *
 * Requires:
 * - Local Supabase running (`npx supabase start`)
 * - .env file with SUPABASE_URL and SUPABASE_ANON_KEY set
 */

require('dotenv').config()

async function testConnection() {
  console.log('Testing Supabase connection...\n')

  // Import the client module (validates it loads without errors)
  let supabase, supabaseConfig
  try {
    const client = require('../src/config/supabase')
    supabase = client.supabase
    supabaseConfig = client.supabaseConfig
    console.log('✓ Supabase client module loaded successfully')
    console.log(`  URL: ${supabaseConfig.url}`)
    console.log(`  Has service role: ${supabaseConfig.hasServiceRole}`)
  } catch (error) {
    console.error('✗ Failed to load Supabase client module:')
    console.error(`  ${error.message}`)
    process.exit(1)
  }

  // Test a simple query (list tables - doesn't require any data)
  try {
    // Use a simple RPC call or query that works on empty database
    // This tests actual connectivity, not just module loading
    const { data, error } = await supabase
      .from('_health_check_dummy')
      .select('*')
      .limit(1)

    // We expect this to fail with "relation does not exist"
    // which proves we connected to the database
    if (error && error.code === '42P01') {
      console.log('✓ Connected to Supabase database successfully')
      console.log('  (Table not found error confirms connection works)')
    } else if (error) {
      // Other errors might indicate connection issues
      console.log('? Received unexpected response:')
      console.log(`  Error: ${error.message}`)
    } else {
      console.log('✓ Query executed successfully')
    }
  } catch (error) {
    console.error('✗ Failed to connect to Supabase:')
    console.error(`  ${error.message}`)
    console.error('\n  Make sure local Supabase is running:')
    console.error('  npx supabase start')
    process.exit(1)
  }

  console.log('\n✓ All smoke tests passed!')
  console.log('\nNext steps:')
  console.log('  1. Run `npx supabase start` if not already running')
  console.log('  2. Run this script again to verify connection')
  console.log('  3. Proceed to Phase 2 for schema design')
}

testConnection().catch(console.error)
```

3. Add a convenience npm script to package.json. Add to scripts section:
   ```json
   "test:supabase": "node scripts/test-supabase-connection.js"
   ```

This smoke test verifies:
- The client module loads without errors
- Environment variables are read correctly
- The client can actually reach the Supabase instance
- We get a meaningful database response (even if it's "table not found")
  </action>
  <verify>
    - `ls contact-backend/scripts/test-supabase-connection.js` exists
    - `grep "test:supabase" contact-backend/package.json` shows the npm script
    - `node -c contact-backend/scripts/test-supabase-connection.js` shows valid syntax
  </verify>
  <done>
    - Smoke test script created that imports and uses supabase.js
    - Script tests actual database connectivity, not just module loading
    - npm script added for convenient execution
    - Provides clear output about connection status
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Supabase CLI structure exists:
   ```bash
   ls -la supabase/
   # Should show: config.toml, migrations/, seed.sql
   ```

2. Dependencies installed:
   ```bash
   cd contact-backend && npm ls @supabase/supabase-js
   # Should show the package
   ```

3. Client module is syntactically valid:
   ```bash
   node -c contact-backend/src/config/supabase.js
   # Should output "contact-backend/src/config/supabase.js syntax ok" or similar
   # Note: Will throw error about missing env vars, which is expected
   ```

4. Smoke test script exists and is syntactically valid:
   ```bash
   node -c contact-backend/scripts/test-supabase-connection.js
   ```
</verification>

<success_criteria>
- [ ] `supabase/config.toml` exists with project_id = "edwards-engineering"
- [ ] `supabase/migrations/` directory exists (empty is fine)
- [ ] `@supabase/supabase-js` in contact-backend/package.json dependencies
- [ ] `supabase` in contact-backend/package.json devDependencies
- [ ] `contact-backend/src/config/supabase.js` exists and exports supabase, supabaseAdmin
- [ ] `contact-backend/scripts/test-supabase-connection.js` exists and imports the client
- [ ] `npm run test:supabase` script added to package.json
</success_criteria>

<output>
After completion, create `.planning/phases/01-local-development-environment/01-01-SUMMARY.md`
</output>
