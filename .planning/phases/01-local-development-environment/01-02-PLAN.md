---
phase: 01-local-development-environment
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - contact-backend/.env.template
  - contact-backend/.env
  - .gitignore
  - docs/LOCAL_DEVELOPMENT.md
autonomous: false

must_haves:
  truths:
    - "Developer can copy .env.template to .env and fill in values"
    - ".env file is gitignored and never committed"
    - "Local Supabase starts successfully with npx supabase start"
    - "Backend can connect to local Supabase instance"
    - "Developer can follow docs/LOCAL_DEVELOPMENT.md to set up from scratch"
  artifacts:
    - path: "contact-backend/.env.template"
      provides: "Environment variable template with documentation"
      contains: "SUPABASE_URL"
    - path: "contact-backend/.env"
      provides: "Local development environment (gitignored)"
      contains: "localhost:54323"
    - path: "docs/LOCAL_DEVELOPMENT.md"
      provides: "Step-by-step local development setup guide"
      contains: "supabase start"
  key_links:
    - from: "contact-backend/.env"
      to: "contact-backend/src/config/supabase.js"
      via: "process.env.SUPABASE_URL"
      pattern: "SUPABASE_URL=http://localhost"
    - from: "docs/LOCAL_DEVELOPMENT.md"
      to: "contact-backend/.env.template"
      via: "documentation reference"
      pattern: "\\.env\\.template"
---

<objective>
Set up environment variable management for local Supabase development, document the local development workflow, and verify the complete setup.

Purpose: Ensure developers can easily configure and switch between local and production Supabase instances with clear documentation.

Output:
- `.env.template` with all required Supabase variables documented
- `.env` configured for local Supabase (port 54323)
- `docs/LOCAL_DEVELOPMENT.md` with complete setup guide
- Verified local Supabase stack running
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-local-development-environment/01-RESEARCH.md
@.planning/phases/01-local-development-environment/01-01-SUMMARY.md
@contact-backend/.gitignore (if exists)
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create environment variable template and local .env</name>
  <files>
    contact-backend/.env.template
    contact-backend/.env
    .gitignore
  </files>
  <action>
1. Create `contact-backend/.env.template` with comprehensive documentation:

```bash
# =============================================================================
# Edwards Engineering Backend - Environment Configuration
# =============================================================================
# Copy this file to .env and fill in the values
# NEVER commit .env to git - it contains secrets!
# =============================================================================

# -----------------------------------------------------------------------------
# Supabase Configuration
# -----------------------------------------------------------------------------
# For LOCAL development (Supabase CLI):
#   SUPABASE_URL=http://localhost:54323
#   SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
#   SUPABASE_SERVICE_ROLE_KEY=(get from `npx supabase status`)
#
# For PRODUCTION (self-hosted on Proxmox):
#   SUPABASE_URL=https://supabase.edwardstech.dev
#   SUPABASE_ANON_KEY=(from production .env JWT generation)
#   SUPABASE_SERVICE_ROLE_KEY=(from production .env JWT generation)
# -----------------------------------------------------------------------------

SUPABASE_URL=
SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# -----------------------------------------------------------------------------
# Legacy Database Configuration (will be removed after migration)
# Keep these for backward compatibility during migration
# -----------------------------------------------------------------------------

DB_HOST=postgres-service
DB_PORT=5432
DB_NAME=ecommerce
DB_USER=ecommerce_user
DB_PASSWORD=

# -----------------------------------------------------------------------------
# Application Configuration
# -----------------------------------------------------------------------------

NODE_ENV=development
PORT=3001
FRONTEND_URL=http://localhost:3000

# -----------------------------------------------------------------------------
# JWT Authentication (will be replaced by Supabase Auth in Phase 3)
# -----------------------------------------------------------------------------

JWT_SECRET=
ADMIN_USER=admin
ADMIN_PASS=

# -----------------------------------------------------------------------------
# Email Configuration (Nodemailer)
# -----------------------------------------------------------------------------

EMAIL_USER=
EMAIL_APP_PASSWORD=

# -----------------------------------------------------------------------------
# Stripe Payment Processing
# -----------------------------------------------------------------------------

STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
```

2. Create `contact-backend/.env` for local development with Supabase CLI defaults:

```bash
# Local Development Environment - DO NOT COMMIT
# Generated for Supabase CLI local development

# Supabase Configuration (local CLI defaults)
SUPABASE_URL=http://localhost:54323
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU

# Legacy Database (keep during migration)
DB_HOST=localhost
DB_PORT=54322
DB_NAME=postgres
DB_USER=postgres
DB_PASSWORD=postgres

# Application
NODE_ENV=development
PORT=3001
FRONTEND_URL=http://localhost:3000

# JWT (temporary - will be replaced by Supabase Auth)
JWT_SECRET=local-dev-jwt-secret-change-in-production
ADMIN_USER=admin
ADMIN_PASS=localdevpassword

# Email (fill in your own for testing)
EMAIL_USER=
EMAIL_APP_PASSWORD=

# Stripe (fill in test keys for development)
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
```

3. Verify `.gitignore` includes `.env` patterns. Check root `.gitignore` already has:
   - `.env` (yes, line 40)
   - `contact-backend/.env*` (yes, line 93)
   - `!contact-backend/.env.template` (yes, line 94)

   If these patterns are missing, add them. Based on the existing .gitignore, they're already present.

4. Double-check the template is NOT gitignored by verifying the `!` exception pattern exists.
  </action>
  <verify>
    - `ls contact-backend/.env.template` exists
    - `ls contact-backend/.env` exists
    - `grep "SUPABASE_URL" contact-backend/.env.template` shows the variable
    - `grep "localhost:54323" contact-backend/.env` shows local URL
    - `git check-ignore contact-backend/.env` returns the file (is ignored)
    - `git check-ignore contact-backend/.env.template` returns nothing (NOT ignored)
  </verify>
  <done>
    - .env.template created with all Supabase variables documented
    - .env created with local Supabase CLI defaults
    - .env is gitignored, .env.template is not
    - Documentation explains local vs production values
  </done>
</task>

<task type="auto">
  <name>Task 2: Create local development documentation</name>
  <files>
    docs/LOCAL_DEVELOPMENT.md
  </files>
  <action>
1. Create the `docs/` directory if it doesn't exist:
   ```bash
   mkdir -p docs
   ```

2. Create `docs/LOCAL_DEVELOPMENT.md` with comprehensive setup guide:

```markdown
# Local Development Setup

This guide explains how to set up the local development environment for Edwards Engineering website.

## Prerequisites

- **Node.js** 18+ (LTS recommended)
- **Docker** with Docker Compose (for Supabase CLI)
- **npm** or **yarn**

## Quick Start

```bash
# 1. Clone the repository
git clone <repo-url>
cd Professional-Website

# 2. Install dependencies
cd contact-backend
npm install

# 3. Set up environment variables
cp .env.template .env
# Edit .env if needed (defaults work for local Supabase)

# 4. Start local Supabase
cd ..
npx supabase start

# 5. Verify connection
cd contact-backend
npm run test:supabase

# 6. Start the backend
npm run dev
```

## Supabase CLI

We use the [Supabase CLI](https://supabase.com/docs/guides/cli) for local development. The CLI runs a complete Supabase stack in Docker containers.

### Installing Supabase CLI

The CLI is installed as a dev dependency:
```bash
npm install --save-dev supabase
```

### Starting Local Supabase

```bash
# From project root
npx supabase start
```

First run downloads Docker images (may take a few minutes). Subsequent starts are fast.

### Checking Status

```bash
npx supabase status
```

Shows:
- **API URL**: http://localhost:54323 (Supabase API)
- **Studio URL**: http://localhost:54323 (Dashboard)
- **DB URL**: postgresql://postgres:postgres@localhost:54322/postgres
- **anon key**: JWT for anonymous access
- **service_role key**: JWT for admin access

### Stopping Supabase

```bash
npx supabase stop
```

To also remove Docker volumes (reset database):
```bash
npx supabase stop --no-backup
```

## Supabase Studio

Access the local Supabase dashboard at: http://localhost:54323

Features:
- **Table Editor**: View and edit database tables
- **SQL Editor**: Run SQL queries
- **Authentication**: Manage users (Phase 3)
- **Storage**: Manage file uploads (future)

## Environment Variables

Copy `.env.template` to `.env`:
```bash
cd contact-backend
cp .env.template .env
```

### Local Development Values

For local Supabase CLI, these values are standard:

| Variable | Local Value |
|----------|-------------|
| `SUPABASE_URL` | `http://localhost:54323` |
| `SUPABASE_ANON_KEY` | `eyJhbGci...` (CLI default) |
| `SUPABASE_SERVICE_ROLE_KEY` | `eyJhbGci...` (CLI default) |

The default JWT keys are consistent across all Supabase CLI installations.

### Production Values

Production uses self-hosted Supabase on Proxmox. See deployment documentation for production environment setup.

## Running Migrations

```bash
# Apply all migrations
npx supabase db push

# Create a new migration
npx supabase migration new <migration_name>

# View migration history
npx supabase migration list
```

## Testing Supabase Connection

Verify the backend can connect to local Supabase:

```bash
cd contact-backend
npm run test:supabase
```

Expected output:
```
Testing Supabase connection...

✓ Supabase client module loaded successfully
  URL: http://localhost:54323
  Has service role: true
✓ Connected to Supabase database successfully

✓ All smoke tests passed!
```

## Troubleshooting

### Docker not running
```
Error: Cannot connect to Docker daemon
```
Solution: Start Docker Desktop or Docker daemon.

### Port conflict
```
Error: Port 54323 already in use
```
Solution: Stop other Supabase instances or change ports in `supabase/config.toml`.

### Missing environment variables
```
Error: Missing Supabase environment variables
```
Solution: Ensure `.env` file exists and contains `SUPABASE_URL` and `SUPABASE_ANON_KEY`.

### Database connection failed
```
Error: Failed to connect to Supabase
```
Solution: Run `npx supabase start` and verify with `npx supabase status`.

## Architecture Note

The Supabase CLI uses Docker Compose internally to run:
- PostgreSQL database (port 54322)
- PostgREST API (port 54323)
- GoTrue auth service
- Realtime subscriptions
- Storage service

All services are containerized and managed by the CLI. You don't need to interact with Docker directly.
```
  </action>
  <verify>
    - `ls docs/LOCAL_DEVELOPMENT.md` exists
    - `grep "supabase start" docs/LOCAL_DEVELOPMENT.md` shows the start command
    - `grep ".env.template" docs/LOCAL_DEVELOPMENT.md` references the template
    - `grep "npm run test:supabase" docs/LOCAL_DEVELOPMENT.md` references the smoke test
  </verify>
  <done>
    - Comprehensive local development guide created
    - Documents Supabase CLI installation and usage
    - Explains environment variable setup
    - Includes troubleshooting section
    - References smoke test for verification
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Local Supabase Stack</name>
  <what-built>
    Complete local Supabase development environment:
    - Supabase CLI initialized in project
    - Supabase client module created
    - Environment variables configured for local development
    - Local development documentation created
  </what-built>
  <how-to-verify>
1. Start local Supabase (requires Docker running):
   ```bash
   cd /home/logan/Projects/Professional-Website
   npx supabase start
   ```
   Wait for all services to start (first run downloads images, takes a few minutes).

2. Check Supabase status and note the credentials:
   ```bash
   npx supabase status
   ```
   Should show:
   - API URL: http://localhost:54323
   - Studio URL: http://localhost:54323
   - DB URL: postgresql://postgres:postgres@localhost:54322/postgres
   - anon key: (the JWT shown in .env)
   - service_role key: (the JWT shown in .env)

3. Open Supabase Studio dashboard:
   - Navigate to http://localhost:54323 in browser
   - Should see Supabase Studio interface
   - Verify you can access Table Editor, SQL Editor, Authentication tabs

4. Run the smoke test to verify client module works:
   ```bash
   cd contact-backend
   npm run test:supabase
   ```
   Should show all tests passing.

5. (Optional) Stop Supabase when done testing:
   ```bash
   npx supabase stop
   ```
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
Human verification confirms:

1. Docker is running and Supabase CLI can start local stack
2. Supabase Studio accessible at http://localhost:54323
3. Backend can load Supabase client with environment variables
4. Smoke test passes and confirms database connectivity
5. Documentation is clear and complete
</verification>

<success_criteria>
- [ ] `contact-backend/.env.template` exists with all Supabase variables
- [ ] `contact-backend/.env` exists with local development values
- [ ] `.env` is gitignored, `.env.template` is tracked
- [ ] `docs/LOCAL_DEVELOPMENT.md` exists with complete setup guide
- [ ] `npx supabase start` completes successfully
- [ ] Supabase Studio loads at http://localhost:54323
- [ ] `npm run test:supabase` passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-local-development-environment/01-02-SUMMARY.md`
</output>
