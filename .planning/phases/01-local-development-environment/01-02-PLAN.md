---
phase: 01-local-development-environment
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - contact-backend/.env.template
  - contact-backend/.env
  - .gitignore
autonomous: false

must_haves:
  truths:
    - "Developer can copy .env.template to .env and fill in values"
    - ".env file is gitignored and never committed"
    - "Local Supabase starts successfully with npx supabase start"
    - "Backend can connect to local Supabase instance"
  artifacts:
    - path: "contact-backend/.env.template"
      provides: "Environment variable template with documentation"
      contains: "SUPABASE_URL"
    - path: "contact-backend/.env"
      provides: "Local development environment (gitignored)"
      contains: "localhost:54323"
  key_links:
    - from: "contact-backend/.env"
      to: "contact-backend/src/config/supabase.js"
      via: "process.env.SUPABASE_URL"
      pattern: "SUPABASE_URL=http://localhost"
---

<objective>
Set up environment variable management for local Supabase development and verify the complete local development workflow.

Purpose: Ensure developers can easily configure and switch between local and production Supabase instances with clear documentation.

Output:
- `.env.template` with all required Supabase variables documented
- `.env` configured for local Supabase (port 54323)
- Verified local Supabase stack running
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-local-development-environment/01-RESEARCH.md
@.planning/phases/01-local-development-environment/01-01-SUMMARY.md
@contact-backend/.gitignore (if exists)
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create environment variable template and local .env</name>
  <files>
    contact-backend/.env.template
    contact-backend/.env
    .gitignore
  </files>
  <action>
1. Create `contact-backend/.env.template` with comprehensive documentation:

```bash
# =============================================================================
# Edwards Engineering Backend - Environment Configuration
# =============================================================================
# Copy this file to .env and fill in the values
# NEVER commit .env to git - it contains secrets!
# =============================================================================

# -----------------------------------------------------------------------------
# Supabase Configuration
# -----------------------------------------------------------------------------
# For LOCAL development (Supabase CLI):
#   SUPABASE_URL=http://localhost:54323
#   SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
#   SUPABASE_SERVICE_ROLE_KEY=(get from `npx supabase status`)
#
# For PRODUCTION (self-hosted on Proxmox):
#   SUPABASE_URL=https://supabase.edwardstech.dev
#   SUPABASE_ANON_KEY=(from production .env JWT generation)
#   SUPABASE_SERVICE_ROLE_KEY=(from production .env JWT generation)
# -----------------------------------------------------------------------------

SUPABASE_URL=
SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# -----------------------------------------------------------------------------
# Legacy Database Configuration (will be removed after migration)
# Keep these for backward compatibility during migration
# -----------------------------------------------------------------------------

DB_HOST=postgres-service
DB_PORT=5432
DB_NAME=ecommerce
DB_USER=ecommerce_user
DB_PASSWORD=

# -----------------------------------------------------------------------------
# Application Configuration
# -----------------------------------------------------------------------------

NODE_ENV=development
PORT=3001
FRONTEND_URL=http://localhost:3000

# -----------------------------------------------------------------------------
# JWT Authentication (will be replaced by Supabase Auth in Phase 3)
# -----------------------------------------------------------------------------

JWT_SECRET=
ADMIN_USER=admin
ADMIN_PASS=

# -----------------------------------------------------------------------------
# Email Configuration (Nodemailer)
# -----------------------------------------------------------------------------

EMAIL_USER=
EMAIL_APP_PASSWORD=

# -----------------------------------------------------------------------------
# Stripe Payment Processing
# -----------------------------------------------------------------------------

STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
```

2. Create `contact-backend/.env` for local development with Supabase CLI defaults:

```bash
# Local Development Environment - DO NOT COMMIT
# Generated for Supabase CLI local development

# Supabase Configuration (local CLI defaults)
SUPABASE_URL=http://localhost:54323
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU

# Legacy Database (keep during migration)
DB_HOST=localhost
DB_PORT=54322
DB_NAME=postgres
DB_USER=postgres
DB_PASSWORD=postgres

# Application
NODE_ENV=development
PORT=3001
FRONTEND_URL=http://localhost:3000

# JWT (temporary - will be replaced by Supabase Auth)
JWT_SECRET=local-dev-jwt-secret-change-in-production
ADMIN_USER=admin
ADMIN_PASS=localdevpassword

# Email (fill in your own for testing)
EMAIL_USER=
EMAIL_APP_PASSWORD=

# Stripe (fill in test keys for development)
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
```

3. Verify `.gitignore` includes `.env` patterns. Check root `.gitignore` already has:
   - `.env` (yes, line 40)
   - `contact-backend/.env*` (yes, line 93)
   - `!contact-backend/.env.template` (yes, line 94)

   If these patterns are missing, add them. Based on the existing .gitignore, they're already present.

4. Double-check the template is NOT gitignored by verifying the `!` exception pattern exists.
  </action>
  <verify>
    - `ls contact-backend/.env.template` exists
    - `ls contact-backend/.env` exists
    - `grep "SUPABASE_URL" contact-backend/.env.template` shows the variable
    - `grep "localhost:54323" contact-backend/.env` shows local URL
    - `git check-ignore contact-backend/.env` returns the file (is ignored)
    - `git check-ignore contact-backend/.env.template` returns nothing (NOT ignored)
  </verify>
  <done>
    - .env.template created with all Supabase variables documented
    - .env created with local Supabase CLI defaults
    - .env is gitignored, .env.template is not
    - Documentation explains local vs production values
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Local Supabase Stack</name>
  <what-built>
    Complete local Supabase development environment:
    - Supabase CLI initialized in project
    - Supabase client module created
    - Environment variables configured for local development
  </what-built>
  <how-to-verify>
1. Start local Supabase (requires Docker running):
   ```bash
   cd /home/logan/Projects/Professional-Website
   npx supabase start
   ```
   Wait for all services to start (first run downloads images, takes a few minutes).

2. Check Supabase status and note the credentials:
   ```bash
   npx supabase status
   ```
   Should show:
   - API URL: http://localhost:54323
   - Studio URL: http://localhost:54323
   - DB URL: postgresql://postgres:postgres@localhost:54322/postgres
   - anon key: (the JWT shown in .env)
   - service_role key: (the JWT shown in .env)

3. Open Supabase Studio dashboard:
   - Navigate to http://localhost:54323 in browser
   - Should see Supabase Studio interface
   - Verify you can access Table Editor, SQL Editor, Authentication tabs

4. Test the Supabase client module loads without errors:
   ```bash
   cd contact-backend
   node -e "require('dotenv').config(); const { supabaseConfig } = require('./src/config/supabase'); console.log('Supabase URL:', supabaseConfig.url);"
   ```
   Should print: `Supabase URL: http://localhost:54323`

5. (Optional) Stop Supabase when done testing:
   ```bash
   npx supabase stop
   ```
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
Human verification confirms:

1. Docker is running and Supabase CLI can start local stack
2. Supabase Studio accessible at http://localhost:54323
3. Backend can load Supabase client with environment variables
4. All default credentials match between CLI output and .env file
</verification>

<success_criteria>
- [ ] `contact-backend/.env.template` exists with all Supabase variables
- [ ] `contact-backend/.env` exists with local development values
- [ ] `.env` is gitignored, `.env.template` is tracked
- [ ] `npx supabase start` completes successfully
- [ ] Supabase Studio loads at http://localhost:54323
- [ ] Backend Supabase client loads without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-local-development-environment/01-02-SUMMARY.md`
</output>
