---
phase: 02-schema-backend-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260128000001_initial_schema.sql
  - supabase/migrations/20260128000002_add_triggers.sql
  - supabase/seed.sql
autonomous: true

must_haves:
  truths:
    - "Database schema matches existing tables structure"
    - "All four tables exist with correct columns and constraints"
    - "Products table uses VARCHAR(50) PK not UUID"
    - "Customers table has address, shipping_address, AND billing_address columns (three separate columns)"
    - "Orders table has customer_address, shipping_address, AND billing_address columns (three separate columns)"
    - "Updated_at columns auto-update on record changes"
    - "RLS is enabled on all tables"
    - "Seed data provides testable records for development"
  artifacts:
    - path: "supabase/migrations/20260128000001_initial_schema.sql"
      provides: "Initial database schema with orders, admin_users, customers, products tables"
      contains: "CREATE TABLE IF NOT EXISTS orders"
    - path: "supabase/migrations/20260128000002_add_triggers.sql"
      provides: "Timestamp automation triggers"
      contains: "moddatetime"
    - path: "supabase/seed.sql"
      provides: "Development seed data"
      contains: "INSERT INTO"
  key_links:
    - from: "supabase/migrations/20260128000001_initial_schema.sql"
      to: "supabase/migrations/20260128000002_add_triggers.sql"
      via: "migration order"
      pattern: "20260128000001.*20260128000002"
---

<objective>
Create Supabase database migrations that replicate the existing PostgreSQL schema from database.js

Purpose: Convert the inline DDL from database.js into tracked, versioned Supabase migrations that can be applied consistently across local and production environments.

Output: Two migration files (schema + triggers) and seed data for development testing
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-schema-backend-refactor/02-RESEARCH.md
@contact-backend/database.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create initial schema migration</name>
  <files>supabase/migrations/20260128000001_initial_schema.sql</files>
  <action>
Create the initial schema migration by converting the DDL from database.js:

1. Create migration file: `supabase/migrations/20260128000001_initial_schema.sql`

2. Include all four tables with exact column definitions from database.js:

   - **orders**: UUID PK (gen_random_uuid), customer fields, JSONB items, DECIMAL amounts, status/payment tracking, timestamps
     - customer_name VARCHAR(255) NOT NULL
     - customer_email VARCHAR(255) NOT NULL
     - customer_phone VARCHAR(20)
     - customer_address TEXT (legacy field)
     - shipping_address TEXT
     - billing_address TEXT
     - items JSONB NOT NULL
     - subtotal DECIMAL(10,2) NOT NULL
     - tax DECIMAL(10,2) DEFAULT 0
     - total DECIMAL(10,2) NOT NULL
     - currency VARCHAR(3) DEFAULT 'USD'
     - status VARCHAR(50) DEFAULT 'pending'
     - payment_intent_id VARCHAR(255)
     - payment_status VARCHAR(50) DEFAULT 'pending'
     - tracking_number VARCHAR(255)
     - notes TEXT
     - created_at/updated_at TIMESTAMPTZ

   - **admin_users**: UUID PK, username (UNIQUE VARCHAR(50)), password_hash VARCHAR(255), email VARCHAR(255), last_login TIMESTAMPTZ, timestamps

   - **customers**: UUID PK, name VARCHAR(255), email (UNIQUE VARCHAR(255)), phone VARCHAR(50), PLUS THREE separate address columns:
     - address TEXT (legacy field - must be included)
     - shipping_address TEXT
     - billing_address TEXT
     - created_at/updated_at TIMESTAMPTZ

   - **products**: VARCHAR(50) PK (NOT UUID - preserve existing key format like 'custom-pcb-001'), name VARCHAR(255), description TEXT, DECIMAL(10,2) price, category VARCHAR(100), JSONB images/options, in_stock BOOLEAN DEFAULT true, timestamps

3. Enable RLS on ALL tables with `ALTER TABLE tablename ENABLE ROW LEVEL SECURITY;`

4. Create service_role policy for each table (allows backend full access):
   ```sql
   CREATE POLICY "Service role has full access" ON tablename
     FOR ALL USING (auth.jwt()->>'role' = 'service_role');
   ```

5. Add indexes for common query patterns:
   - orders: customer_email, status, created_at DESC
   - customers: email
   - products: category, in_stock

Important: Use TIMESTAMPTZ (not TIMESTAMP) for all timestamp columns to match Supabase conventions.
  </action>
  <verify>
Run `supabase db reset` from project root. Check Supabase Studio (http://localhost:54323) shows all 4 tables with correct columns. Run SQL in Studio: `SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';` - should list orders, admin_users, customers, products. Verify customers table has address, shipping_address, and billing_address columns. Verify products table id column is VARCHAR(50) not UUID.
  </verify>
  <done>
Four tables created with matching schema to database.js (including all three address columns on customers and orders), RLS enabled, service_role policies created, indexes added for query performance.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create triggers migration and seed data</name>
  <files>supabase/migrations/20260128000002_add_triggers.sql, supabase/seed.sql</files>
  <action>
Create timestamp automation triggers and development seed data:

**Part A: Triggers migration (supabase/migrations/20260128000002_add_triggers.sql)**

1. Enable moddatetime extension:
   ```sql
   CREATE EXTENSION IF NOT EXISTS moddatetime SCHEMA extensions;
   ```

2. Create triggers for updated_at automation on all tables with updated_at column:
   ```sql
   CREATE TRIGGER handle_orders_updated_at
     BEFORE UPDATE ON orders
     FOR EACH ROW
     EXECUTE FUNCTION moddatetime(updated_at);
   ```

   Repeat for: customers, admin_users, products

**Part B: Seed data (supabase/seed.sql)**

Create realistic development seed data:

1. **admin_users**: One admin user with bcrypt-hashed password
   - username: 'admin'
   - password_hash: Use bcrypt hash of 'admin123' (for development only)
   - email: 'admin@edwards-engineering.local'

   Generate bcrypt hash: `$2b$10$rQZ8K3.qX5Y6H1JK9LmN0OhVJ8x6Y2q3W4e5R6t7Y8u9I0o1P2q3R` (pre-computed for 'admin123')

2. **products**: 2-3 sample products
   - id: 'custom-pcb-001', name: 'Custom PCB Design', price: 150.00
   - id: 'firmware-dev-001', name: 'Firmware Development', price: 500.00

3. **customers**: 1 sample customer with ALL address fields populated
   - email: 'test@example.com', name: 'Test Customer'
   - address: '123 Main St'
   - shipping_address: '123 Main St, Suite 100'
   - billing_address: '456 Billing Ave'

4. **orders**: 1-2 sample orders with JSONB items
   - Reference customer email and product-like items
   - Various statuses (pending, completed)

Note: Use ON CONFLICT DO NOTHING to make seed idempotent.
  </action>
  <verify>
Run `supabase db reset` to apply migrations and seed. In Supabase Studio SQL Editor, verify:
1. `SELECT * FROM admin_users;` returns 1 row
2. `SELECT * FROM products;` returns 2+ rows
3. `SELECT * FROM orders;` returns sample orders
4. `SELECT address, shipping_address, billing_address FROM customers;` returns all three columns with data
5. Update a record and verify updated_at changes: `UPDATE products SET price = 160 WHERE id = 'custom-pcb-001'; SELECT updated_at FROM products WHERE id = 'custom-pcb-001';`
  </verify>
  <done>
Moddatetime extension enabled, triggers created for all tables, seed data provides working development dataset with all address fields populated.
  </done>
</task>

</tasks>

<verification>
1. Run `supabase db reset` - completes without errors
2. All 4 tables visible in Supabase Studio with correct columns
3. Customers table has address, shipping_address, AND billing_address columns
4. Orders table has customer_address, shipping_address, AND billing_address columns
5. Products table uses VARCHAR(50) for id (not UUID)
6. RLS enabled on all tables (check Studio table settings)
7. Seed data present in all tables
8. Updated_at trigger works (update any record, check timestamp changes)
</verification>

<success_criteria>
- [ ] Migration files exist in supabase/migrations/
- [ ] `supabase db reset` completes successfully
- [ ] All 4 tables have matching columns to database.js
- [ ] Customers table has all 3 address columns (address, shipping_address, billing_address)
- [ ] Orders table has all 3 address columns (customer_address, shipping_address, billing_address)
- [ ] Products table uses VARCHAR(50) PK not UUID
- [ ] RLS enabled on all tables
- [ ] Triggers auto-update updated_at columns
- [ ] Seed data provides testable records
</success_criteria>

<output>
After completion, create `.planning/phases/02-schema-backend-refactor/02-01-SUMMARY.md`
</output>
