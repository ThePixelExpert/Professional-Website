---
phase: 03-auth-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - contact-backend/package.json
  - contact-backend/src/lib/supabase-ssr.js
  - contact-backend/src/middleware/auth.js
  - contact-backend/src/middleware/requireAdmin.js
autonomous: true

must_haves:
  truths:
    - "Express can create per-request Supabase clients with cookie context"
    - "Protected routes reject requests without valid Supabase session"
    - "Admin routes reject requests without admin role in JWT claims"
  artifacts:
    - path: "contact-backend/src/lib/supabase-ssr.js"
      provides: "Per-request Supabase client factory with cookie handling"
      exports: ["createClient"]
    - path: "contact-backend/src/middleware/auth.js"
      provides: "Session verification middleware"
      exports: ["requireAuth"]
    - path: "contact-backend/src/middleware/requireAdmin.js"
      provides: "Admin role authorization middleware"
      exports: ["requireAdmin"]
  key_links:
    - from: "contact-backend/src/middleware/auth.js"
      to: "contact-backend/src/lib/supabase-ssr.js"
      via: "imports createClient"
      pattern: "require.*supabase-ssr"
    - from: "contact-backend/src/middleware/requireAdmin.js"
      to: "contact-backend/src/lib/supabase-ssr.js"
      via: "imports createClient"
      pattern: "require.*supabase-ssr"
---

<objective>
Create backend authentication foundation using @supabase/ssr for Express middleware

Purpose: Replace JWT-based auth with Supabase Auth session verification. This enables cookie-based sessions, proper server-side validation with auth.getUser(), and role-based authorization via JWT custom claims.

Output: SSR client helper, auth middleware, and admin authorization middleware ready for route integration.
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-auth-migration/03-CONTEXT.md
@.planning/phases/03-auth-migration/03-RESEARCH.md
@contact-backend/src/config/supabase.js
@contact-backend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create SSR client helper</name>
  <files>
    contact-backend/package.json
    contact-backend/src/lib/supabase-ssr.js
  </files>
  <action>
1. Install required packages:
   ```bash
   cd contact-backend && npm install @supabase/ssr cookie-parser
   ```

2. Create `contact-backend/src/lib/supabase-ssr.js`:
   - Import `createServerClient`, `parseCookieHeader`, `serializeCookieHeader` from `@supabase/ssr`
   - Export a `createClient(context)` function that:
     - Takes `{ req, res }` Express context
     - Creates Supabase client using `process.env.SUPABASE_URL` and `process.env.SUPABASE_ANON_KEY`
     - Implements `cookies.getAll()` using `parseCookieHeader(req.headers.cookie ?? '')`
     - Implements `cookies.setAll()` using `res.appendHeader('Set-Cookie', serializeCookieHeader(...))`
   - Use CommonJS syntax (require/module.exports) to match existing codebase

Note: This creates per-request clients with proper cookie context. DO NOT reuse clients across requests.
  </action>
  <verify>
    - `ls contact-backend/node_modules/@supabase/ssr` shows package installed
    - `ls contact-backend/node_modules/cookie-parser` shows package installed
    - `node -e "require('./contact-backend/src/lib/supabase-ssr')"` runs without error
  </verify>
  <done>
    - @supabase/ssr and cookie-parser installed in package.json
    - supabase-ssr.js exports createClient function
    - Module loads without syntax errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth and admin authorization middleware</name>
  <files>
    contact-backend/src/middleware/auth.js
    contact-backend/src/middleware/requireAdmin.js
  </files>
  <action>
1. Create `contact-backend/src/middleware/` directory if it doesn't exist

2. Create `contact-backend/src/middleware/auth.js`:
   - Import `createClient` from `../lib/supabase-ssr`
   - Export async `requireAuth(req, res, next)` middleware:
     - Create Supabase client with `{ req, res }` context
     - Call `await supabase.auth.getUser()` (CRITICAL: NOT getSession())
     - If error or no user: return `res.status(401).json({ error: 'Unauthorized' })`
     - Otherwise: attach `req.user = user` and call `next()`
   - Use CommonJS syntax

3. Create `contact-backend/src/middleware/requireAdmin.js`:
   - Import `createClient` from `../lib/supabase-ssr`
   - Export async `requireAdmin(req, res, next)` middleware:
     - Create Supabase client with `{ req, res }` context
     - Call `await supabase.auth.getUser()` to get user
     - If error or no user: return `res.status(401).json({ error: 'Unauthorized' })`
     - Check for admin role in `user.app_metadata?.user_role`
     - If not admin: return `res.status(403).json({ error: 'Admin access required' })`
     - Otherwise: attach `req.user = user` and call `next()`
   - Use CommonJS syntax

Note: Both middleware verify with auth server via getUser(). The admin middleware checks custom claims that will be populated by Auth Hook (created in 03-02).
  </action>
  <verify>
    - `node -e "require('./contact-backend/src/middleware/auth')"` runs without error
    - `node -e "require('./contact-backend/src/middleware/requireAdmin')"` runs without error
    - Both files export the expected function names
  </verify>
  <done>
    - auth.js exports requireAuth middleware
    - requireAdmin.js exports requireAdmin middleware
    - Both use getUser() (not getSession()) for session verification
    - Both modules load without syntax errors
  </done>
</task>

</tasks>

<verification>
1. All dependencies installed: `cd contact-backend && npm ls @supabase/ssr cookie-parser`
2. All modules load:
   ```bash
   node -e "
     const ssr = require('./contact-backend/src/lib/supabase-ssr');
     const auth = require('./contact-backend/src/middleware/auth');
     const admin = require('./contact-backend/src/middleware/requireAdmin');
     console.log('createClient:', typeof ssr.createClient);
     console.log('requireAuth:', typeof auth.requireAuth);
     console.log('requireAdmin:', typeof admin.requireAdmin);
   "
   ```
3. Should output all functions as 'function'
</verification>

<success_criteria>
- @supabase/ssr and cookie-parser in package.json dependencies
- supabase-ssr.js creates per-request clients with cookie handling
- auth.js middleware verifies sessions via getUser()
- requireAdmin.js middleware checks admin role in app_metadata
- All CommonJS modules load without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-auth-migration/03-01-SUMMARY.md`
</output>
