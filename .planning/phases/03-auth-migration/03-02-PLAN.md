---
phase: 03-auth-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260129000001_user_roles.sql
  - supabase/migrations/20260129000002_auth_hook.sql
autonomous: true

must_haves:
  truths:
    - "user_roles table stores user-to-role mappings"
    - "Auth Hook adds user_role claim to JWT on token generation"
    - "RLS policies protect user_roles from unauthorized access"
  artifacts:
    - path: "supabase/migrations/20260129000001_user_roles.sql"
      provides: "user_roles table with RLS policies"
      contains: "CREATE TABLE public.user_roles"
    - path: "supabase/migrations/20260129000002_auth_hook.sql"
      provides: "Custom access token hook function"
      contains: "custom_access_token_hook"
  key_links:
    - from: "supabase/migrations/20260129000002_auth_hook.sql"
      to: "supabase/migrations/20260129000001_user_roles.sql"
      via: "Hook queries user_roles table"
      pattern: "FROM public.user_roles"
---

<objective>
Create database schema for role-based authorization via Supabase Auth Hooks

Purpose: Enable admin authorization by storing user roles in a dedicated table and injecting the role into JWT claims via Auth Hook. This allows both RLS policies and application code to check roles without additional database queries.

Output: Migrations for user_roles table and custom access token hook function.
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-auth-migration/03-CONTEXT.md
@.planning/phases/03-auth-migration/03-RESEARCH.md
@supabase/migrations/20260128000001_initial_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user_roles table migration</name>
  <files>supabase/migrations/20260129000001_user_roles.sql</files>
  <action>
Create `supabase/migrations/20260129000001_user_roles.sql`:

```sql
-- User Roles Migration
-- Stores role assignments for Supabase Auth users
-- Created: 2026-01-29

-- user_roles table
-- Links auth.users to application roles
CREATE TABLE IF NOT EXISTS public.user_roles (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  role TEXT NOT NULL CHECK (role IN ('admin', 'customer')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE (user_id, role)
);

-- Enable RLS
ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;

-- RLS Policies:
-- 1. Service role has full access (for admin operations)
CREATE POLICY "Service role has full access" ON public.user_roles
  FOR ALL USING (auth.jwt()->>'role' = 'service_role');

-- 2. Users can read their own roles (for client-side role checks)
CREATE POLICY "Users can read own roles" ON public.user_roles
  FOR SELECT USING (auth.uid() = user_id);

-- Index for fast lookups by user_id
CREATE INDEX idx_user_roles_user_id ON public.user_roles(user_id);

-- Comment for documentation
COMMENT ON TABLE public.user_roles IS 'Stores user role assignments for authorization. Roles are added to JWT via Auth Hook.';
```

Note: The 'admin' and 'customer' role constraint is strict. Extend the CHECK constraint if more roles needed later.
  </action>
  <verify>
    - File exists at `supabase/migrations/20260129000001_user_roles.sql`
    - Contains CREATE TABLE for user_roles
    - Contains RLS policies
    - Contains foreign key to auth.users
  </verify>
  <done>
    - user_roles table created with user_id (UUID FK), role (TEXT with CHECK)
    - RLS enabled with service_role and user-own-roles policies
    - Index on user_id for performance
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Auth Hook for custom JWT claims</name>
  <files>supabase/migrations/20260129000002_auth_hook.sql</files>
  <action>
Create `supabase/migrations/20260129000002_auth_hook.sql`:

```sql
-- Auth Hook Migration
-- Adds custom claims to JWT for role-based authorization
-- Created: 2026-01-29

-- Custom Access Token Hook
-- This function runs every time a JWT is generated
-- It adds the user's role to the JWT claims
CREATE OR REPLACE FUNCTION public.custom_access_token_hook(event JSONB)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  claims JSONB;
  user_role TEXT;
BEGIN
  -- Get the user's role from user_roles table
  SELECT role INTO user_role
  FROM public.user_roles
  WHERE user_id = (event->>'user_id')::UUID
  LIMIT 1;

  -- Extract existing claims
  claims := event->'claims';

  -- Add user_role claim if role exists
  -- If no role found, user_role will be NULL (treated as unauthenticated for admin checks)
  IF user_role IS NOT NULL THEN
    claims := jsonb_set(claims, '{user_role}', to_jsonb(user_role));
  ELSE
    -- Explicitly set to null so the claim exists but is empty
    claims := jsonb_set(claims, '{user_role}', 'null'::jsonb);
  END IF;

  -- Return modified event with updated claims
  RETURN jsonb_set(event, '{claims}', claims);
END;
$$;

-- Grant execute permission to supabase_auth_admin
-- This is required for the Auth service to call the hook
GRANT EXECUTE ON FUNCTION public.custom_access_token_hook TO supabase_auth_admin;

-- Revoke from public for security
REVOKE EXECUTE ON FUNCTION public.custom_access_token_hook FROM PUBLIC;

-- Comment for documentation
COMMENT ON FUNCTION public.custom_access_token_hook IS
  'Auth Hook: Adds user_role claim to JWT. Register in Supabase Dashboard > Authentication > Hooks > Custom Access Token.';
```

IMPORTANT: After migration runs, the hook must be registered in Supabase Dashboard:
1. Navigate to Authentication > Hooks
2. Enable "Custom Access Token" hook
3. Select function: public.custom_access_token_hook

This step cannot be automated via migration - it requires dashboard configuration.
  </action>
  <verify>
    - File exists at `supabase/migrations/20260129000002_auth_hook.sql`
    - Contains CREATE OR REPLACE FUNCTION custom_access_token_hook
    - Queries user_roles table
    - Adds user_role to claims
    - Has proper security (SECURITY DEFINER, grants)
  </verify>
  <done>
    - custom_access_token_hook function created
    - Function queries user_roles and adds role to JWT claims
    - Proper permissions granted to supabase_auth_admin
    - Function ready for dashboard registration
  </done>
</task>

<task type="auto">
  <name>Task 3: Apply migrations and verify</name>
  <files></files>
  <action>
1. Start Supabase if not running:
   ```bash
   cd /home/logan/Projects/Professional-Website && npx supabase start
   ```

2. Apply the new migrations:
   ```bash
   cd /home/logan/Projects/Professional-Website && npx supabase db reset
   ```
   (db reset applies all migrations from scratch in local dev)

3. Verify tables and function exist:
   ```bash
   cd /home/logan/Projects/Professional-Website && npx supabase db dump --schema public | grep -E "(user_roles|custom_access_token_hook)"
   ```

Note: The Auth Hook registration in dashboard is a manual step that will be addressed in integration testing. For local development, the function exists but won't be called until registered.
  </action>
  <verify>
    - `npx supabase db reset` completes without errors
    - user_roles table exists in database
    - custom_access_token_hook function exists
  </verify>
  <done>
    - Migrations applied successfully
    - user_roles table queryable
    - Auth hook function created and ready for registration
  </done>
</task>

</tasks>

<verification>
1. Migrations exist in correct order:
   ```bash
   ls -la supabase/migrations/ | grep 20260129
   ```

2. After `npx supabase db reset`, verify schema:
   ```bash
   npx supabase db dump --schema public 2>/dev/null | grep -E "CREATE TABLE.*user_roles|CREATE.*FUNCTION.*custom_access_token_hook"
   ```

3. Check RLS is enabled:
   ```bash
   npx supabase db dump --schema public 2>/dev/null | grep -A1 "user_roles.*ENABLE ROW LEVEL SECURITY"
   ```
</verification>

<success_criteria>
- user_roles table created with proper constraints and RLS
- custom_access_token_hook function created with correct logic
- Migrations apply without errors
- Schema matches expected structure
</success_criteria>

<output>
After completion, create `.planning/phases/03-auth-migration/03-02-SUMMARY.md`
</output>
