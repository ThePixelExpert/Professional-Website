---
phase: 03-auth-migration
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - contact-backend/server.js
autonomous: true

must_haves:
  truths:
    - "Admin routes use Supabase session verification instead of JWT"
    - "Protected routes reject requests without valid Supabase session"
    - "Old JWT middleware is removed from admin routes"
  artifacts:
    - path: "contact-backend/server.js"
      provides: "Express server with Supabase auth middleware"
      contains: "requireAdmin"
  key_links:
    - from: "contact-backend/server.js"
      to: "contact-backend/src/middleware/requireAdmin.js"
      via: "imports and uses requireAdmin middleware"
      pattern: "require.*middleware/requireAdmin"
    - from: "contact-backend/server.js"
      to: "contact-backend/src/lib/supabase-ssr.js"
      via: "cookie-parser middleware enables cookie reading"
      pattern: "cookie-parser"
---

<objective>
Update Express server to use Supabase Auth middleware for protected routes

Purpose: Replace the legacy JWT-based authMiddleware with Supabase session verification. This enables cookie-based sessions, proper server-side validation, and role-based authorization.

Output: server.js updated to use requireAdmin middleware on admin routes, with cookie-parser enabled.
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-auth-migration/03-CONTEXT.md
@.planning/phases/03-auth-migration/03-RESEARCH.md
@contact-backend/server.js
@contact-backend/src/middleware/auth.js
@contact-backend/src/middleware/requireAdmin.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cookie-parser and update imports</name>
  <files>contact-backend/server.js</files>
  <action>
1. Read `contact-backend/server.js` to understand current structure

2. Add new imports at the top (after existing requires):
   ```javascript
   const cookieParser = require('cookie-parser');
   const { requireAdmin } = require('./src/middleware/requireAdmin');
   ```

3. Add cookie-parser middleware BEFORE route definitions (after `app.use(express.json())`):
   ```javascript
   app.use(cookieParser());
   ```

4. Keep the old `authMiddleware` function for now (will be used during transition)
   - We'll remove it after verifying Supabase auth works

Note: Cookie-parser is required for @supabase/ssr to read authentication cookies from requests.
  </action>
  <verify>
    - server.js imports cookie-parser
    - server.js imports requireAdmin from middleware
    - cookie-parser middleware is added to Express app
  </verify>
  <done>
    - cookie-parser imported and used as middleware
    - requireAdmin imported from middleware module
    - Express app configured to parse cookies
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace authMiddleware with requireAdmin on protected routes</name>
  <files>contact-backend/server.js</files>
  <action>
1. Find all routes using `authMiddleware`:
   - GET /api/orders
   - PUT /api/orders/:id
   - GET /api/orders/:id/receipt
   - POST /api/orders/:id/send-receipt
   - Any other admin-only routes

2. Replace `authMiddleware` with `requireAdmin` on these routes:
   ```javascript
   // Before:
   app.get('/api/orders', authMiddleware, async (req, res) => { ... });

   // After:
   app.get('/api/orders', requireAdmin, async (req, res) => { ... });
   ```

3. Update all routes that previously used authMiddleware:
   - app.get('/api/orders', requireAdmin, ...)
   - app.put('/api/orders/:id', requireAdmin, ...)
   - app.get('/api/orders/:id/receipt', requireAdmin, ...)
   - app.post('/api/orders/:id/send-receipt', requireAdmin, ...)

4. Remove or comment out the old authMiddleware function definition (lines ~22-32)

5. Remove the old /api/admin/login endpoint that generated JWT tokens - this will be replaced by Supabase OAuth on the frontend

6. Keep ADMIN_USER, ADMIN_PASS, JWT_SECRET variables for now - they can be removed after full migration is verified

Note: The requireAdmin middleware now handles both authentication (is user logged in?) and authorization (is user an admin?).
  </action>
  <verify>
    - All previously protected routes now use requireAdmin middleware
    - Old authMiddleware function is removed or commented out
    - Server starts without errors: `cd contact-backend && node -c server.js`
  </verify>
  <done>
    - All admin routes protected with requireAdmin middleware
    - Old JWT-based authMiddleware removed
    - Server syntax is valid
  </done>
</task>

<task type="auto">
  <name>Task 3: Add session management endpoints</name>
  <files>contact-backend/server.js</files>
  <action>
1. Add a session check endpoint for frontend auth state verification:
   ```javascript
   const { createClient } = require('./src/lib/supabase-ssr');

   // Check current session status
   app.get('/api/auth/session', async (req, res) => {
     const supabase = createClient({ req, res });
     const { data: { user }, error } = await supabase.auth.getUser();

     if (error || !user) {
       return res.json({ authenticated: false, user: null });
     }

     // Return user info (without sensitive data)
     res.json({
       authenticated: true,
       user: {
         id: user.id,
         email: user.email,
         role: user.app_metadata?.user_role || null
       }
     });
   });
   ```

2. Add a signout endpoint for global session revocation:
   ```javascript
   // Sign out (revokes all sessions)
   app.post('/api/auth/signout', async (req, res) => {
     const supabase = createClient({ req, res });

     const { error } = await supabase.auth.signOut({ scope: 'global' });

     if (error) {
       console.error('Signout error:', error);
       return res.status(500).json({ error: 'Failed to sign out' });
     }

     res.json({ success: true });
   });
   ```

3. Add createClient import at top of file if not already added:
   ```javascript
   const { createClient } = require('./src/lib/supabase-ssr');
   ```

Note: These endpoints help the frontend verify auth state and properly sign out across all devices.
  </action>
  <verify>
    - /api/auth/session endpoint exists and returns user info
    - /api/auth/signout endpoint exists and calls supabase.auth.signOut
    - Server starts without errors
  </verify>
  <done>
    - /api/auth/session endpoint returns authenticated status and user info
    - /api/auth/signout endpoint revokes all sessions globally
    - Both endpoints use createClient from supabase-ssr
  </done>
</task>

</tasks>

<verification>
1. Verify server syntax:
   ```bash
   cd contact-backend && node -c server.js
   ```

2. Verify imports are correct:
   ```bash
   grep -E "require.*cookie-parser|require.*requireAdmin|require.*supabase-ssr" contact-backend/server.js
   ```

3. Verify routes use new middleware:
   ```bash
   grep -E "requireAdmin" contact-backend/server.js | head -5
   ```

4. Start server and check health:
   ```bash
   cd contact-backend && timeout 5 node server.js &
   sleep 2 && curl http://localhost:3001/api/health && kill %1
   ```
</verification>

<success_criteria>
- cookie-parser middleware enabled
- All admin routes use requireAdmin middleware
- Old authMiddleware removed
- /api/auth/session returns user status
- /api/auth/signout revokes sessions globally
- Server starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-auth-migration/03-03-SUMMARY.md`
</output>
