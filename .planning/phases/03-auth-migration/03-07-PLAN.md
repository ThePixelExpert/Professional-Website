---
phase: 03-auth-migration
plan: 07
type: execute
wave: 4
depends_on: ["03-05", "03-06"]
files_modified:
  - contact-backend/server.js
  - .env.template
autonomous: false

must_haves:
  truths:
    - "Admin can complete full OAuth login flow"
    - "Customer can create account and view orders"
    - "Protected API routes reject unauthenticated requests"
    - "Google OAuth is configured in Supabase"
  artifacts:
    - path: ".env.template"
      provides: "Updated environment variable documentation"
      contains: "REACT_APP_SUPABASE"
  key_links:
    - from: "Admin OAuth flow"
      to: "Supabase Auth"
      via: "Google provider configuration"
      pattern: "Google OAuth"
---

<objective>
Add customer API endpoint and perform integration verification

Purpose: Complete the auth migration by adding the customer orders endpoint and verifying the full authentication flow works end-to-end.

Output: Working customer API endpoint, verified auth flows, updated environment documentation.
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-auth-migration/03-CONTEXT.md
@.planning/phases/03-auth-migration/03-RESEARCH.md
@contact-backend/server.js
@.env.template
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add customer orders API endpoint</name>
  <files>contact-backend/server.js</files>
  <action>
Add a customer-facing orders endpoint to server.js:

```javascript
const { requireAuth } = require('./src/middleware/auth');

// Customer: Get own orders
app.get('/api/customer/orders', requireAuth, async (req, res) => {
  try {
    // req.user is set by requireAuth middleware
    const userId = req.user.id;

    // Query orders for this user
    const result = await db.query(
      `SELECT id, items, subtotal, tax, total, currency, status,
              tracking_number, created_at, updated_at
       FROM orders
       WHERE user_id = $1
       ORDER BY created_at DESC`,
      [userId]
    );

    res.json({ orders: result.rows || result });
  } catch (err) {
    console.error('Error fetching customer orders:', err);
    res.status(500).json({ error: 'Failed to fetch orders' });
  }
});
```

Add the requireAuth import at the top of the file with other middleware imports:
```javascript
const { requireAuth } = require('./src/middleware/auth');
```

Note: This endpoint uses requireAuth (any logged-in user), not requireAdmin. Customers can only see their own orders due to the WHERE user_id clause.
  </action>
  <verify>
    - server.js contains /api/customer/orders endpoint
    - Endpoint uses requireAuth middleware
    - Queries only orders belonging to the authenticated user
  </verify>
  <done>
    - Customer orders endpoint added
    - Protected by requireAuth middleware
    - Returns only orders matching user_id
  </done>
</task>

<task type="auto">
  <name>Task 2: Update environment templates</name>
  <files>
    .env.template
    contact-backend/.env.template
  </files>
  <action>
1. Update root `.env.template` (if exists) or create with frontend vars:

```bash
# Frontend Environment Variables (React)
# Copy this file to .env and fill in values

# Supabase Configuration (same values as backend)
REACT_APP_SUPABASE_URL=http://127.0.0.1:54321
REACT_APP_SUPABASE_ANON_KEY=your-anon-key-from-supabase-start

# API URL (local development)
REACT_APP_API_URL=http://localhost:3001
```

2. Update `contact-backend/.env.template` to add any auth-specific notes:

Add a section for auth configuration:
```bash
# =============================================================================
# AUTHENTICATION (Supabase Auth)
# =============================================================================
# Google OAuth is configured in Supabase Dashboard, not here.
# After running 'npx supabase start', configure Google OAuth:
# 1. Go to http://127.0.0.1:54323 (Supabase Studio)
# 2. Navigate to Authentication > Providers > Google
# 3. Add your Google OAuth credentials
#
# To get Google OAuth credentials:
# 1. Go to https://console.cloud.google.com/
# 2. Create OAuth 2.0 Client ID
# 3. Add authorized redirect URI: http://127.0.0.1:54321/auth/v1/callback

# Auth Hook Configuration:
# After migrations, register the custom_access_token_hook:
# 1. Go to Supabase Studio > Authentication > Hooks
# 2. Enable "Custom Access Token" hook
# 3. Select function: public.custom_access_token_hook
```

This documents the OAuth setup steps that can't be automated.
  </action>
  <verify>
    - .env.template includes REACT_APP_SUPABASE_* variables
    - contact-backend/.env.template documents OAuth setup steps
    - Instructions are clear for both local dev and production
  </verify>
  <done>
    - Frontend env vars documented
    - OAuth configuration steps documented
    - Auth Hook registration steps documented
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Supabase Auth integration for admin OAuth and customer accounts:
    - Backend: SSR client, auth middleware, admin middleware, session endpoints
    - Database: user_roles table, Auth Hook function, orders.user_id column
    - Frontend: AuthContext, ProtectedRoute, AdminRoute, CustomerAuth, AccountPage
    - Admin: Google OAuth login, protected dashboard
    - Customer: Email/password + Google login, order history page
  </what-built>
  <how-to-verify>
    **Prerequisites:**
    1. Start Supabase: `cd /home/logan/Projects/Professional-Website && npx supabase start`
    2. Note the API URL and anon key from output
    3. Configure environment:
       - Set REACT_APP_SUPABASE_URL and REACT_APP_SUPABASE_ANON_KEY in root .env
       - Ensure contact-backend/.env has SUPABASE_URL and SUPABASE_ANON_KEY

    **Configure Google OAuth (required for admin login):**
    1. Open Supabase Studio: http://127.0.0.1:54323
    2. Go to Authentication > Providers > Google
    3. Enable Google provider
    4. Add Google OAuth credentials (from Google Cloud Console)
    5. Set redirect URL in Google Console: http://127.0.0.1:54321/auth/v1/callback

    **Register Auth Hook:**
    1. In Supabase Studio, go to Authentication > Hooks
    2. Enable "Custom Access Token" hook
    3. Select function: public.custom_access_token_hook

    **Add test admin user:**
    1. In Supabase Studio > SQL Editor, run:
       ```sql
       -- After logging in with Google, get your user ID from auth.users
       -- Then insert admin role:
       INSERT INTO public.user_roles (user_id, role)
       VALUES ('your-user-id-here', 'admin');
       ```

    **Test Admin Flow:**
    1. Start backend: `cd contact-backend && npm start`
    2. Start frontend: `npm start`
    3. Navigate to http://localhost:3000/#/admin/login
    4. Click "Sign in with Google"
    5. Complete Google OAuth flow
    6. Verify redirect to admin dashboard
    7. Verify admin features work (view orders, etc.)
    8. Click Logout, verify redirect to login page

    **Test Customer Flow:**
    1. Navigate to http://localhost:3000/#/login
    2. Create account with email/password
    3. Check email for confirmation (if enabled)
    4. Log in with created account
    5. Navigate to http://localhost:3000/#/account
    6. Verify order history displays (will be empty initially)
    7. Sign out and verify redirect

    **Test Protected Routes:**
    1. In a private/incognito window, go to http://localhost:3000/#/admin
    2. Verify redirect to login page
    3. Go to http://localhost:3000/#/account
    4. Verify redirect to login page
  </how-to-verify>
  <resume-signal>Type "approved" if all auth flows work correctly, or describe any issues encountered.</resume-signal>
</task>

</tasks>

<verification>
1. Customer orders endpoint exists:
   ```bash
   grep "/api/customer/orders" contact-backend/server.js
   ```

2. Environment templates updated:
   ```bash
   grep "REACT_APP_SUPABASE" .env.template
   grep "Auth Hook" contact-backend/.env.template
   ```

3. All auth components in place:
   ```bash
   ls -la src/lib/supabase.js src/contexts/AuthContext.js src/components/AdminRoute.js src/components/CustomerAuth.js src/components/AccountPage.js
   ```
</verification>

<success_criteria>
- Customer orders API endpoint works for authenticated users
- Environment templates document all required variables
- Admin can log in via Google OAuth and access dashboard
- Customer can create account and view order history
- Protected routes redirect unauthenticated users
- Logout revokes sessions globally
</success_criteria>

<output>
After completion, create `.planning/phases/03-auth-migration/03-07-SUMMARY.md`
</output>
