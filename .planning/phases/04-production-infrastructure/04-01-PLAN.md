---
phase: 04-production-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - production/.env.template
  - production/generate-secrets.sh
  - production/README.md
autonomous: true

must_haves:
  truths:
    - "Production secrets can be generated securely"
    - "Environment template documents all required variables"
    - "Deployment process is documented"
  artifacts:
    - path: "production/.env.template"
      provides: "Documented environment configuration template"
      contains: "JWT_SECRET"
    - path: "production/generate-secrets.sh"
      provides: "Cryptographically secure secret generation"
      contains: "openssl rand"
    - path: "production/README.md"
      provides: "Deployment documentation"
      contains: "Prerequisites"
  key_links:
    - from: "production/generate-secrets.sh"
      to: "production/.env.template"
      via: "Secret variable names match template"
      pattern: "JWT_SECRET|POSTGRES_PASSWORD|ANON_KEY"
---

<objective>
Create production configuration foundation with environment template, secrets generator, and deployment documentation.

Purpose: Establish the configuration infrastructure needed before deploying Supabase to Proxmox. This ensures all secrets are generated securely and the deployment process is documented.

Output: production/ directory with .env.template, generate-secrets.sh, and README.md
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-production-infrastructure/04-RESEARCH.md

# Existing env templates for reference
@contact-backend/.env.template
@.env.template
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create production environment template</name>
  <files>production/.env.template</files>
  <action>
Create production/.env.template with comprehensive documentation for all Supabase Docker Compose variables.

Structure into sections:
1. **Secrets** (must generate before first start):
   - POSTGRES_PASSWORD (alphanumeric only, 32 chars)
   - JWT_SECRET (base64, 48+ chars)
   - ANON_KEY (JWT token - generate via script or supabase CLI)
   - SERVICE_ROLE_KEY (JWT token - generate via script or supabase CLI)
   - SECRET_KEY_BASE (base64, 48+ chars)
   - VAULT_ENC_KEY (hex, exactly 32 chars)
   - LOGFLARE_PUBLIC_ACCESS_TOKEN
   - LOGFLARE_PRIVATE_ACCESS_TOKEN

2. **API URLs** (set for edwardstech.dev):
   - SUPABASE_PUBLIC_URL=https://supabase.edwardstech.dev
   - API_EXTERNAL_URL=https://supabase.edwardstech.dev
   - SITE_URL=https://www.edwardstech.dev

3. **Database** (internal Docker networking):
   - POSTGRES_HOST=db
   - POSTGRES_DB=postgres
   - POSTGRES_PORT=5432

4. **Auth - Google OAuth**:
   - GOTRUE_EXTERNAL_GOOGLE_ENABLED=true
   - GOTRUE_EXTERNAL_GOOGLE_CLIENT_ID=(placeholder)
   - GOTRUE_EXTERNAL_GOOGLE_SECRET=(placeholder)
   - GOTRUE_EXTERNAL_GOOGLE_REDIRECT_URI=https://supabase.edwardstech.dev/auth/v1/callback

5. **SMTP** (optional, can be configured later):
   - Comment out SMTP settings with placeholders

6. **Storage**:
   - STORAGE_BACKEND=file

Include inline comments explaining:
- Where to get each value
- Generation commands for secrets
- What NOT to change after first start
- Reference to generate-secrets.sh for automated generation
  </action>
  <verify>File exists and contains all required environment variable sections (grep for JWT_SECRET, POSTGRES_PASSWORD, API_EXTERNAL_URL)</verify>
  <done>.env.template contains documented configuration for all Supabase Docker Compose environment variables with edwardstech.dev URLs</done>
</task>

<task type="auto">
  <name>Task 2: Create secrets generation script</name>
  <files>production/generate-secrets.sh</files>
  <action>
Create production/generate-secrets.sh that generates all required secrets using openssl.

Script should:
1. Generate each secret type with appropriate format:
   - JWT_SECRET: `openssl rand -base64 48`
   - SECRET_KEY_BASE: `openssl rand -base64 48`
   - VAULT_ENC_KEY: `openssl rand -hex 16`
   - POSTGRES_PASSWORD: `openssl rand -base64 32 | tr -d '/+=' | head -c 32`
   - LOGFLARE tokens: `openssl rand -base64 32 | tr -d '/+=' | head -c 32`

2. For ANON_KEY and SERVICE_ROLE_KEY:
   - Output placeholder with instructions to use Supabase JWT generator
   - Link to: https://supabase.com/docs/guides/self-hosting/docker#generate-api-keys
   - Note: These require the JWT_SECRET to sign, so they must be generated after

3. Output in format that can be copied to .env:
   ```
   # Generated secrets - copy to .env
   POSTGRES_PASSWORD=abc123...
   JWT_SECRET=xyz789...
   ```

4. Include warning at top:
   - "DO NOT regenerate after first start - will break existing tokens"
   - "Generate ANON_KEY and SERVICE_ROLE_KEY after setting JWT_SECRET"

5. Make script executable (chmod +x)
  </action>
  <verify>chmod +x production/generate-secrets.sh && ./production/generate-secrets.sh 2>&1 | head -20 (verify it outputs secret values)</verify>
  <done>generate-secrets.sh generates all required secrets with proper formats and clear instructions for API keys</done>
</task>

<task type="auto">
  <name>Task 3: Create production deployment README</name>
  <files>production/README.md</files>
  <action>
Create production/README.md documenting the complete deployment process.

Structure:
1. **Overview**
   - Architecture diagram (text-based): Internet -> Caddy -> Kong -> Supabase Services
   - Domain: supabase.edwardstech.dev
   - Target: Proxmox VM with Docker

2. **Prerequisites**
   - Proxmox server with VM capability
   - Domain DNS pointing to VM IP (supabase.edwardstech.dev)
   - Google OAuth credentials (from Phase 3)
   - Port 80/443 open for Let's Encrypt

3. **Deployment Steps** (high-level, details in subsequent plans):
   - [ ] Create Proxmox VM (see 04-02-PLAN)
   - [ ] Generate secrets and configure .env
   - [ ] Deploy Supabase stack
   - [ ] Deploy Caddy reverse proxy
   - [ ] Configure backup automation
   - [ ] Apply migrations
   - [ ] Verify OAuth and API access

4. **File Structure**:
   ```
   production/
   ├── .env.template          # Configuration template
   ├── .env                    # Actual config (gitignored)
   ├── generate-secrets.sh    # Secret generation
   ├── docker-compose.yml     # Supabase stack
   ├── docker-compose.caddy.yml  # Reverse proxy
   ├── docker-compose.backup.yml # Backup service
   └── README.md              # This file
   ```

5. **Environment Parity**
   - Explain how local (Supabase CLI) and production (Docker Compose) stay aligned
   - Migrations: Same files applied to both
   - Auth hooks: Manual registration in both environments
   - OAuth: Separate Google OAuth apps for local vs production

6. **Maintenance**
   - Update procedure (docker compose pull && restart)
   - Backup verification
   - Log access

Do NOT include actual Docker Compose files yet - those are in subsequent plans.
  </action>
  <verify>cat production/README.md | grep -c "Prerequisites" (should be >= 1)</verify>
  <done>README.md provides complete deployment overview with prerequisites, steps, and file structure</done>
</task>

</tasks>

<verification>
- [ ] production/ directory exists with 3 files
- [ ] .env.template contains all Supabase Docker Compose variables
- [ ] generate-secrets.sh is executable and generates secrets
- [ ] README.md documents deployment process
</verification>

<success_criteria>
- Environment template documents every required variable for production Supabase
- Secrets can be generated with a single script execution
- Deployment process is documented end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/04-production-infrastructure/04-01-SUMMARY.md`
</output>
