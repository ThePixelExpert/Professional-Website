---
phase: 04-production-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - production/vm-setup.sh
  - docs/PROXMOX_VM_SETUP.md
autonomous: false

must_haves:
  truths:
    - "VM setup process is documented step-by-step"
    - "Docker installation is automated via script"
    - "Storage volume configuration is specified"
  artifacts:
    - path: "production/vm-setup.sh"
      provides: "Docker installation and configuration script"
      contains: "get-docker.sh"
    - path: "docs/PROXMOX_VM_SETUP.md"
      provides: "VM creation documentation"
      contains: "Proxmox"
  key_links:
    - from: "docs/PROXMOX_VM_SETUP.md"
      to: "production/vm-setup.sh"
      via: "Documentation references script"
      pattern: "vm-setup.sh"
---

<objective>
Create Proxmox VM setup documentation and Docker installation script.

Purpose: The VM is the foundation for all production services. This plan documents the manual VM creation process in Proxmox and provides an automated script for Docker installation and storage configuration.

Output: VM setup documentation and installation script ready for execution on new VM
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-production-infrastructure/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Docker installation script</name>
  <files>production/vm-setup.sh</files>
  <action>
Create production/vm-setup.sh that prepares a fresh Ubuntu VM for Supabase deployment.

Script requirements:
1. **Header with usage**:
   ```bash
   #!/bin/bash
   # Supabase VM Setup Script
   # Run as root on a fresh Ubuntu 22.04 LTS VM
   # Usage: sudo ./vm-setup.sh
   ```

2. **Pre-flight checks**:
   - Verify running as root
   - Verify Ubuntu 22.04 (lsb_release check)
   - Verify /dev/sdb exists (data disk)

3. **System updates**:
   ```bash
   apt update && apt upgrade -y
   apt install -y curl git
   ```

4. **Format and mount data disk** (if not already mounted):
   - Check if /opt is already mounted on sdb
   - If not: mkfs.ext4 /dev/sdb
   - Add to /etc/fstab: /dev/sdb /opt ext4 defaults 0 2
   - Mount /opt

5. **Install Docker Engine** (NOT Docker Desktop):
   ```bash
   curl -fsSL https://get.docker.com -o get-docker.sh
   sh get-docker.sh
   ```

6. **Configure Docker**:
   - Add current user to docker group
   - Configure Docker to store data in /opt/docker
   - Create /etc/docker/daemon.json with data-root: /opt/docker

7. **Create directory structure**:
   ```bash
   mkdir -p /opt/supabase
   mkdir -p /opt/caddy
   mkdir -p /opt/backups/postgres
   ```

8. **Clone Supabase Docker**:
   ```bash
   git clone --depth 1 https://github.com/supabase/supabase /tmp/supabase
   cp -rf /tmp/supabase/docker/* /opt/supabase/
   cp /tmp/supabase/docker/.env.example /opt/supabase/.env
   ```

9. **Final output**:
   - Print success message
   - Print next steps (copy .env.template, generate secrets)
   - Print warning about logging out/in for docker group

Make script executable.
  </action>
  <verify>bash -n production/vm-setup.sh (syntax check) && chmod +x production/vm-setup.sh</verify>
  <done>vm-setup.sh installs Docker, configures storage, and clones Supabase Docker files</done>
</task>

<task type="auto">
  <name>Task 2: Create Proxmox VM setup documentation</name>
  <files>docs/PROXMOX_VM_SETUP.md</files>
  <action>
Create docs/PROXMOX_VM_SETUP.md with step-by-step VM creation instructions.

Structure:
1. **Overview**
   - Purpose: Dedicated VM for Supabase production deployment
   - Why VM over LXC: Docker compatibility, live migration, no Proxmox update breakage
   - Target specs: 4 cores, 8GB RAM, 60GB OS + 120GB data

2. **Prerequisites**
   - Proxmox VE 7.x or 8.x
   - Ubuntu Server 22.04 LTS ISO uploaded to Proxmox
   - Network configured (192.168.0.x or your LAN)
   - SSH access to Proxmox host

3. **Step 1: Create VM in Proxmox UI**
   - Click "Create VM"
   - General: Name "supabase-prod", VM ID (next available)
   - OS: Select Ubuntu 22.04 ISO
   - System: BIOS (SeaBIOS), Machine (q35), SCSI Controller (VirtIO SCSI)
   - Disks: 60GB VirtIO Block on local storage
   - CPU: 4 cores, Type "host"
   - Memory: 8192 MB (8GB), no ballooning
   - Network: Bridge (vmbr0), VirtIO

4. **Step 2: Add Data Disk**
   - Select VM -> Hardware -> Add -> Hard Disk
   - Bus/Device: VirtIO Block
   - Storage: local (or your storage pool)
   - Disk size: 120GB
   - Note: This will be /dev/sdb in the VM

5. **Step 3: Install Ubuntu**
   - Start VM, open console
   - Install Ubuntu Server with minimal install
   - Create user "supabase" (or your preferred username)
   - Enable OpenSSH server during install
   - Reboot and note IP address

6. **Step 4: Configure Static IP (Optional)**
   - Edit /etc/netplan/00-installer-config.yaml
   - Set static IP if DHCP reservation not used
   - Example config provided

7. **Step 5: Run Setup Script**
   ```bash
   # SSH into VM
   ssh supabase@<VM_IP>

   # Copy setup script from project
   scp production/vm-setup.sh supabase@<VM_IP>:~/

   # Run setup
   sudo ./vm-setup.sh
   ```

8. **Step 6: Verify Setup**
   - Log out and back in (for docker group)
   - `docker ps` should work without sudo
   - `df -h /opt` should show 120GB disk
   - `/opt/supabase` should contain docker-compose.yml

9. **Troubleshooting**
   - Docker permission denied: Log out/in or `newgrp docker`
   - /dev/sdb not found: Check Proxmox hardware, ensure disk is attached
   - Network issues: Verify bridge configuration

Include screenshots alternatives as ASCII diagrams where helpful.
  </action>
  <verify>cat docs/PROXMOX_VM_SETUP.md | grep -c "Step" (should be >= 6 steps)</verify>
  <done>PROXMOX_VM_SETUP.md provides complete step-by-step VM creation and configuration instructions</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Create Proxmox VM following the documentation</action>
  <instructions>
**Manual VM Creation Required**

Claude cannot create Proxmox VMs programmatically. Please follow the documentation in `docs/PROXMOX_VM_SETUP.md` to:

1. Create VM in Proxmox UI with:
   - 4 cores, 8GB RAM
   - 60GB OS disk
   - 120GB data disk

2. Install Ubuntu 22.04 LTS

3. SSH into VM and run setup script:
   ```bash
   scp production/vm-setup.sh <username>@<VM_IP>:~/
   ssh <username>@<VM_IP>
   sudo ./vm-setup.sh
   ```

4. Verify Docker is working:
   ```bash
   docker --version
   docker compose version
   ls /opt/supabase/
   ```

**Note:** DNS configuration for supabase.edwardstech.dev will be handled after Caddy is deployed (need to know the VM's IP first).
  </instructions>
  <resume-signal>Type "VM ready" with the VM's IP address, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
- [ ] vm-setup.sh is executable and passes syntax check
- [ ] PROXMOX_VM_SETUP.md contains all setup steps
- [ ] User confirms VM is created and setup script completed
- [ ] Docker and docker compose are working on VM
</verification>

<success_criteria>
- VM is running Ubuntu 22.04 with Docker installed
- /opt partition is mounted on separate disk
- /opt/supabase contains Supabase Docker files
- Docker commands work without sudo
</success_criteria>

<output>
After completion, create `.planning/phases/04-production-infrastructure/04-02-SUMMARY.md`
</output>
