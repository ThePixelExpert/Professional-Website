---
phase: 04-production-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - production/docker-compose.override.yml
  - production/deploy.sh
autonomous: true

must_haves:
  truths:
    - "Supabase services start successfully with custom configuration"
    - "Kong is configured with Caddy proxy labels"
    - "Deployment can be run with a single script"
  artifacts:
    - path: "production/docker-compose.override.yml"
      provides: "Custom Supabase configuration for edwardstech.dev"
      contains: "caddy"
    - path: "production/deploy.sh"
      provides: "Deployment automation script"
      contains: "docker compose"
  key_links:
    - from: "production/deploy.sh"
      to: "production/docker-compose.override.yml"
      via: "Script uses override file"
      pattern: "docker-compose.override.yml"
    - from: "production/docker-compose.override.yml"
      to: "Kong service"
      via: "Caddy labels for reverse proxy"
      pattern: "caddy\\.reverse_proxy"
---

<objective>
Create Supabase Docker Compose customizations and deployment script for edwardstech.dev.

Purpose: Customize the official Supabase Docker Compose with Caddy proxy labels and create a deployment script for consistent deployments.

Output: docker-compose.override.yml with edwardstech.dev configuration and deploy.sh for one-command deployment
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-production-infrastructure/04-RESEARCH.md
@production/.env.template
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Docker Compose override file</name>
  <files>production/docker-compose.override.yml</files>
  <action>
Create production/docker-compose.override.yml that customizes the official Supabase stack.

Use Docker Compose override pattern (DO NOT copy the entire docker-compose.yml - just override specific services).

Content:
```yaml
# Docker Compose Override for Edwards Engineering Production
# This file extends the official Supabase docker-compose.yml
# Place in /opt/supabase/ alongside the official docker-compose.yml

services:
  # Add Caddy proxy labels to Kong (API Gateway)
  kong:
    labels:
      caddy: supabase.edwardstech.dev
      caddy.reverse_proxy: "{{upstreams 8000}}"
    networks:
      - default
      - caddy_network

  # Ensure Studio is accessible via subdomain (optional, can be disabled in production)
  studio:
    labels:
      caddy: studio.edwardstech.dev
      caddy.reverse_proxy: "{{upstreams 3000}}"
    networks:
      - default
      - caddy_network

networks:
  caddy_network:
    external: true
    name: caddy_network
```

**Why override file instead of modifying docker-compose.yml:**
- Official file can be updated without losing customizations
- `docker compose pull` won't overwrite our changes
- Clear separation between official config and our customizations

**Note on Kong port:** Kong internally runs on 8000 (HTTP). Caddy handles HTTPS termination.

**Note on Studio:** Studio access can be restricted later via Caddy configuration or disabled entirely for security.
  </action>
  <verify>docker compose -f /dev/null -f production/docker-compose.override.yml config 2>&1 | grep -q "kong" && echo "Valid override file"</verify>
  <done>docker-compose.override.yml adds Caddy labels to Kong and Studio services with proper networking</done>
</task>

<task type="auto">
  <name>Task 2: Create deployment script</name>
  <files>production/deploy.sh</files>
  <action>
Create production/deploy.sh that handles the full deployment process.

Script structure:
```bash
#!/bin/bash
# Supabase Production Deployment Script
# Usage: ./deploy.sh [command]
# Commands:
#   start     - Start all services
#   stop      - Stop all services
#   restart   - Restart all services
#   pull      - Pull latest images
#   update    - Pull and restart (causes brief downtime)
#   logs      - Show logs
#   status    - Show service status
#   env-check - Verify environment configuration

set -e

SUPABASE_DIR="/opt/supabase"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper functions
log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Verify environment
check_env() {
    if [ ! -f "$SUPABASE_DIR/.env" ]; then
        log_error ".env file not found at $SUPABASE_DIR/.env"
        log_info "Copy .env.template to .env and configure it first"
        exit 1
    fi

    # Check for placeholder values
    if grep -q "your-.*-here\|<generate\|CHANGEME" "$SUPABASE_DIR/.env"; then
        log_error "Placeholder values found in .env - configure all secrets first"
        exit 1
    fi

    log_info "Environment check passed"
}

# Copy override file if not present
setup_override() {
    if [ ! -f "$SUPABASE_DIR/docker-compose.override.yml" ]; then
        log_info "Copying docker-compose.override.yml..."
        cp "$SCRIPT_DIR/docker-compose.override.yml" "$SUPABASE_DIR/"
    fi
}

# Create Caddy network if not exists
ensure_network() {
    if ! docker network inspect caddy_network >/dev/null 2>&1; then
        log_info "Creating caddy_network..."
        docker network create caddy_network
    fi
}

# Main commands
cmd_start() {
    check_env
    setup_override
    ensure_network
    cd "$SUPABASE_DIR"
    log_info "Starting Supabase services..."
    docker compose up -d
    log_info "Waiting for services to be healthy..."
    sleep 30
    docker compose ps
}

cmd_stop() {
    cd "$SUPABASE_DIR"
    log_info "Stopping Supabase services..."
    docker compose down
}

cmd_restart() {
    cmd_stop
    cmd_start
}

cmd_pull() {
    cd "$SUPABASE_DIR"
    log_info "Pulling latest images..."
    docker compose pull
}

cmd_update() {
    log_warn "This will cause brief service downtime!"
    read -p "Continue? (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        cmd_pull
        cmd_restart
    fi
}

cmd_logs() {
    cd "$SUPABASE_DIR"
    docker compose logs -f --tail=100
}

cmd_status() {
    cd "$SUPABASE_DIR"
    docker compose ps
}

cmd_env_check() {
    check_env
    log_info "Checking required variables..."

    source "$SUPABASE_DIR/.env"

    required_vars=(
        "POSTGRES_PASSWORD"
        "JWT_SECRET"
        "ANON_KEY"
        "SERVICE_ROLE_KEY"
        "API_EXTERNAL_URL"
        "SUPABASE_PUBLIC_URL"
        "SITE_URL"
    )

    missing=0
    for var in "${required_vars[@]}"; do
        if [ -z "${!var}" ]; then
            log_error "Missing: $var"
            missing=$((missing + 1))
        else
            log_info "Found: $var"
        fi
    done

    if [ $missing -gt 0 ]; then
        log_error "$missing required variables missing"
        exit 1
    fi

    log_info "All required variables configured!"
}

# Parse command
case "${1:-help}" in
    start)   cmd_start ;;
    stop)    cmd_stop ;;
    restart) cmd_restart ;;
    pull)    cmd_pull ;;
    update)  cmd_update ;;
    logs)    cmd_logs ;;
    status)  cmd_status ;;
    env-check) cmd_env_check ;;
    *)
        echo "Usage: $0 {start|stop|restart|pull|update|logs|status|env-check}"
        exit 1
        ;;
esac
```

Make script executable.
  </action>
  <verify>bash -n production/deploy.sh && chmod +x production/deploy.sh && echo "Script valid and executable"</verify>
  <done>deploy.sh provides start/stop/restart/update/logs/status commands for managing Supabase deployment</done>
</task>

<task type="auto">
  <name>Task 3: Update production README with deployment commands</name>
  <files>production/README.md</files>
  <action>
Update production/README.md to add the deployment commands section.

Add after the "Deployment Steps" section:

## Deployment Commands

After VM setup and .env configuration, deploy Supabase:

```bash
# SSH into VM
ssh <user>@<VM_IP>

# Copy production files to VM (from local machine)
scp -r production/* <user>@<VM_IP>:/opt/supabase/

# On the VM:
cd /opt/supabase

# Verify environment configuration
./deploy.sh env-check

# Start all services
./deploy.sh start

# Check status
./deploy.sh status

# View logs
./deploy.sh logs
```

### Available Commands

| Command | Description |
|---------|-------------|
| `./deploy.sh start` | Start all Supabase services |
| `./deploy.sh stop` | Stop all services |
| `./deploy.sh restart` | Stop and start services |
| `./deploy.sh pull` | Pull latest Docker images |
| `./deploy.sh update` | Pull images and restart (causes downtime) |
| `./deploy.sh logs` | Follow service logs |
| `./deploy.sh status` | Show service status |
| `./deploy.sh env-check` | Verify .env configuration |

### First-Time Setup

1. Copy .env.template to .env
2. Run `./generate-secrets.sh` and copy secrets to .env
3. Generate ANON_KEY and SERVICE_ROLE_KEY (see below)
4. Configure Google OAuth credentials
5. Run `./deploy.sh start`

### Generating API Keys

ANON_KEY and SERVICE_ROLE_KEY are JWTs signed with your JWT_SECRET.

Option 1: Use Supabase JWT Generator
- Visit: https://supabase.com/docs/guides/self-hosting/docker#generate-api-keys
- Enter your JWT_SECRET
- Copy generated keys

Option 2: Use the Supabase CLI (requires Node.js)
```bash
npx supabase gen keys --jwt-secret <your-jwt-secret>
```

Also update the File Structure section to include new files:
```
production/
├── .env.template              # Configuration template
├── .env                       # Actual config (gitignored, on VM only)
├── generate-secrets.sh        # Secret generation script
├── docker-compose.override.yml # Caddy labels and networking
├── deploy.sh                  # Deployment management script
└── README.md                  # This file
```
  </action>
  <verify>grep -c "deploy.sh" production/README.md (should be >= 5 mentions)</verify>
  <done>README.md includes deployment commands documentation and updated file structure</done>
</task>

</tasks>

<verification>
- [ ] docker-compose.override.yml is valid YAML
- [ ] deploy.sh passes bash syntax check
- [ ] deploy.sh is executable
- [ ] README.md documents all deployment commands
</verification>

<success_criteria>
- Override file adds Caddy labels without modifying official docker-compose.yml
- deploy.sh provides all common deployment operations
- Documentation explains first-time setup and API key generation
</success_criteria>

<output>
After completion, create `.planning/phases/04-production-infrastructure/04-03-SUMMARY.md`
</output>
