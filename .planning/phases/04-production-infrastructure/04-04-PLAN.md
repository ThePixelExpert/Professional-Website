---
phase: 04-production-infrastructure
plan: 04
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - production/docker-compose.caddy.yml
  - production/Caddyfile
autonomous: true

must_haves:
  truths:
    - "Caddy automatically obtains SSL certificates from Let's Encrypt"
    - "HTTPS traffic is proxied to Kong on internal network"
    - "Caddy configuration is maintainable and well-documented"
  artifacts:
    - path: "production/docker-compose.caddy.yml"
      provides: "Caddy reverse proxy deployment"
      contains: "caddy-docker-proxy"
    - path: "production/Caddyfile"
      provides: "Backup static configuration"
      contains: "reverse_proxy"
  key_links:
    - from: "production/docker-compose.caddy.yml"
      to: "Docker socket"
      via: "Volume mount for label discovery"
      pattern: "/var/run/docker.sock"
    - from: "Caddy"
      to: "supabase_default network"
      via: "External network connection"
      pattern: "external: true"
---

<objective>
Create Caddy reverse proxy configuration with automatic SSL for supabase.edwardstech.dev.

Purpose: Caddy provides automatic SSL certificate management via Let's Encrypt, eliminating manual certificate handling. It proxies HTTPS traffic to Kong (Supabase API gateway) on the internal Docker network.

Output: docker-compose.caddy.yml and Caddyfile for reverse proxy deployment
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-production-infrastructure/04-RESEARCH.md
@production/docker-compose.override.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Caddy Docker Compose file</name>
  <files>production/docker-compose.caddy.yml</files>
  <action>
Create production/docker-compose.caddy.yml for the Caddy reverse proxy.

Use caddy-docker-proxy image which automatically discovers Docker labels.

```yaml
# Caddy Reverse Proxy for Supabase
# Automatically obtains Let's Encrypt SSL certificates
# Discovers routing via Docker labels on containers
#
# Deploy: docker compose -f docker-compose.caddy.yml up -d
# Logs: docker compose -f docker-compose.caddy.yml logs -f

services:
  caddy:
    image: lucaslorentz/caddy-docker-proxy:latest
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"    # HTTP (for Let's Encrypt ACME challenge)
      - "443:443"  # HTTPS
    environment:
      # Network where labeled containers are running
      - CADDY_INGRESS_NETWORKS=supabase_default
    volumes:
      # Docker socket for label discovery (read-only for security)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Persistent storage for certificates and config
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - supabase_default
      - caddy_network

volumes:
  caddy_data:
    driver: local
  caddy_config:
    driver: local

networks:
  # Connect to Supabase's default network to reach Kong
  supabase_default:
    external: true
  # Network for other services that need HTTPS
  caddy_network:
    driver: bridge
```

**Key configuration choices:**
- Uses `caddy-docker-proxy` (NOT vanilla Caddy) - reads Docker labels automatically
- Mounts Docker socket read-only for security
- Named volumes for certificate persistence (survives container recreation)
- Connects to `supabase_default` network created by Supabase docker-compose
- Exposes ports 80 (ACME challenge) and 443 (HTTPS)

**How it works:**
1. Caddy reads labels from containers on `supabase_default` network
2. Labels on Kong (from docker-compose.override.yml) tell Caddy the domain and upstream
3. Caddy automatically requests Let's Encrypt certificate for supabase.edwardstech.dev
4. HTTPS traffic is proxied to Kong:8000 on internal network
  </action>
  <verify>docker compose -f production/docker-compose.caddy.yml config >/dev/null 2>&1 && echo "Valid Compose file"</verify>
  <done>docker-compose.caddy.yml configures Caddy with Docker label discovery and SSL certificate persistence</done>
</task>

<task type="auto">
  <name>Task 2: Create backup Caddyfile for manual configuration</name>
  <files>production/Caddyfile</files>
  <action>
Create production/Caddyfile as a backup static configuration.

This file is NOT used by caddy-docker-proxy (which uses labels), but serves as:
1. Documentation of the routing configuration
2. Fallback if label-based config has issues
3. Reference for adding custom routes

```
# Caddyfile - Backup/Reference Configuration
# This file is NOT used by caddy-docker-proxy (uses Docker labels instead)
# Keep this as documentation and fallback configuration
#
# To use this file directly:
# 1. Replace caddy-docker-proxy with vanilla caddy image
# 2. Mount this file to /etc/caddy/Caddyfile
# 3. Remove Docker socket mount

# Supabase API (Kong)
supabase.edwardstech.dev {
    # Proxy to Kong API Gateway
    reverse_proxy kong:8000

    # Security headers
    header {
        # Enable HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"
        # XSS protection
        X-Content-Type-Options "nosniff"
        # Remove server header
        -Server
    }

    # Logging
    log {
        output file /var/log/caddy/supabase.log
        format json
    }
}

# Supabase Studio (optional - can be disabled for security)
studio.edwardstech.dev {
    reverse_proxy studio:3000

    # Basic auth for Studio access (recommended)
    # Generate hash: caddy hash-password
    # basicauth {
    #     admin $2a$14$... (hashed password)
    # }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Frame-Options "DENY"
    }

    log {
        output file /var/log/caddy/studio.log
        format json
    }
}

# Alternative: Single domain with path-based routing
# api.edwardstech.dev {
#     handle /studio/* {
#         uri strip_prefix /studio
#         reverse_proxy studio:3000
#     }
#     handle {
#         reverse_proxy kong:8000
#     }
# }
```

Add a note in the file header explaining when to use this vs Docker labels.
  </action>
  <verify>test -f production/Caddyfile && grep -q "supabase.edwardstech.dev" production/Caddyfile</verify>
  <done>Caddyfile provides documented backup configuration and reference for Caddy routing</done>
</task>

<task type="auto">
  <name>Task 3: Create Caddy deployment documentation</name>
  <files>production/README.md</files>
  <action>
Update production/README.md to add Caddy deployment section.

Add after the "Deployment Commands" section:

## Reverse Proxy (Caddy)

Caddy handles SSL termination and proxies traffic to Supabase services.

### How It Works

```
Internet (HTTPS :443)
        ↓
    Caddy (SSL termination)
        ↓ HTTP
    Kong (:8000, internal network)
        ↓
    Supabase Services
```

Caddy uses Docker labels to discover routing configuration:
- Labels on Kong container → supabase.edwardstech.dev
- Labels on Studio container → studio.edwardstech.dev (optional)

### Deploy Caddy

```bash
# On the VM, after Supabase is running:
cd /opt/supabase

# Start Caddy (will auto-request SSL certificates)
docker compose -f docker-compose.caddy.yml up -d

# Check logs for certificate status
docker compose -f docker-compose.caddy.yml logs -f
```

### SSL Certificate

Caddy automatically:
1. Requests Let's Encrypt certificate on first start
2. Renews certificate before expiration
3. Handles OCSP stapling

**Requirements for certificate issuance:**
- DNS must point supabase.edwardstech.dev to VM's public IP
- Port 80 must be accessible (ACME HTTP challenge)
- Port 443 for HTTPS traffic

### DNS Configuration

Before starting Caddy, configure DNS:

1. In Cloudflare (or your DNS provider):
   - Add A record: `supabase.edwardstech.dev` → `<VM_IP>`
   - Add A record: `studio.edwardstech.dev` → `<VM_IP>` (optional)

2. If using Cloudflare proxy (orange cloud):
   - Caddy will still get certificates (Cloudflare handles external SSL)
   - Set SSL mode to "Full (strict)" in Cloudflare

3. If NOT using Cloudflare proxy (grey cloud / DNS only):
   - Caddy handles SSL directly with Let's Encrypt
   - Ensure ports 80/443 are forwarded to VM

### Troubleshooting

**Certificate not issued:**
```bash
# Check Caddy logs
docker logs caddy

# Common issues:
# - DNS not propagated (wait or check with dig)
# - Port 80 blocked (firewall/router)
# - Rate limited (Let's Encrypt limits)
```

**Services not discovered:**
```bash
# Verify Supabase network exists
docker network ls | grep supabase

# Check Kong labels
docker inspect kong | grep -A 10 Labels
```

Also update the deployment checklist in README to include:
- [ ] Configure DNS for supabase.edwardstech.dev
- [ ] Deploy Caddy reverse proxy
- [ ] Verify SSL certificate is issued
  </action>
  <verify>grep -c "Caddy" production/README.md (should be >= 10 mentions)</verify>
  <done>README.md includes comprehensive Caddy deployment and DNS configuration documentation</done>
</task>

</tasks>

<verification>
- [ ] docker-compose.caddy.yml is valid and references correct networks
- [ ] Caddyfile contains documented routing configuration
- [ ] README.md explains Caddy deployment and DNS requirements
</verification>

<success_criteria>
- Caddy docker-compose is ready for deployment
- Documentation explains DNS and SSL requirements
- Backup Caddyfile provides reference for manual configuration
</success_criteria>

<output>
After completion, create `.planning/phases/04-production-infrastructure/04-04-SUMMARY.md`
</output>
