---
phase: 06-gitops-with-flux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/build-and-push.sh
  - .github/workflows/build-and-push.yml
autonomous: true

must_haves:
  truths:
    - "Image tags are sortable by Flux ImagePolicy (contain timestamp component)"
    - "Git push to master triggers automated image builds via GitHub Actions"
    - "Both frontend (ARM64) and backend (AMD64) images are built and pushed to Harbor"
  artifacts:
    - path: "scripts/build-and-push.sh"
      provides: "Build script with Flux-compatible sortable tags"
      contains: "main-.*-.*date"
    - path: ".github/workflows/build-and-push.yml"
      provides: "GitHub Actions workflow for automated builds"
      contains: "self-hosted"
  key_links:
    - from: ".github/workflows/build-and-push.yml"
      to: "scripts/build-and-push.sh"
      via: "workflow step runs the build script"
      pattern: "build-and-push\\.sh"
    - from: "scripts/build-and-push.sh"
      to: "192.168.0.40:5000"
      via: "docker buildx push to Harbor registry"
      pattern: "192\\.168\\.0\\.40:5000"
---

<objective>
Update image tag format for Flux compatibility and create GitHub Actions CI workflow.

Purpose: Flux ImagePolicy requires sortable tags to determine "latest" image. Current pure git SHA tags (abc1234) cannot be sorted. Adding a timestamp component (main-abc1234-1707300000) makes tags sortable alphabetically. The GitHub Actions workflow automates builds on push to master using a self-hosted runner with LAN access to Harbor.

Output: Updated build-and-push.sh with sortable tags, GitHub Actions workflow file.
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-gitops-with-flux/06-RESEARCH.md
@scripts/build-and-push.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update build-and-push.sh tag format for Flux compatibility</name>
  <files>scripts/build-and-push.sh</files>
  <action>
    Modify the tag format in scripts/build-and-push.sh:

    1. Change the GIT_SHA line and add a TIMESTAMP variable:
       ```
       GIT_SHA=$(git rev-parse --short HEAD)
       TIMESTAMP=$(date +%s)
       IMAGE_TAG="main-${GIT_SHA}-${TIMESTAMP}"
       ```

    2. Replace all uses of `${GIT_SHA}` as image tag with `${IMAGE_TAG}`:
       - Frontend: `${REGISTRY}/frontend:${IMAGE_TAG}` (was `${REGISTRY}/frontend:${GIT_SHA}`)
       - Backend: `${REGISTRY}/backend:${IMAGE_TAG}` (was `${REGISTRY}/backend:${GIT_SHA}`)

    3. Keep the `:latest` tags as secondary tags (Flux uses the sortable tag, but latest is useful for manual pulls).

    4. Update all echo/output lines to show IMAGE_TAG instead of GIT_SHA where it refers to the tag.

    5. Update the deploy summary section at the bottom to show both GIT_SHA and IMAGE_TAG.

    6. Update registry cleanup logic: the `sort -r` already works since alphabetical sorting of `main-SHA-TIMESTAMP` naturally puts newest timestamps last. Keep the cleanup logic that retains last 5 tags.

    7. Keep the `GIT_SHA` variable (used for display and by deploy-backend.sh), but the Docker image tag is now `IMAGE_TAG`.

    Important: Do NOT change the build-arg logic, platform specifications, or .env.production sourcing. Only change the tagging.
  </action>
  <verify>
    Run `bash -n scripts/build-and-push.sh` to verify syntax.
    Grep for the new tag pattern: `grep 'IMAGE_TAG' scripts/build-and-push.sh` should show the sortable tag format.
    Grep to confirm no raw `${GIT_SHA}` remains as a Docker tag: `grep -n 'GIT_SHA' scripts/build-and-push.sh` should only show it in display/variable lines, not in `-t` docker tag arguments.
  </verify>
  <done>
    build-and-push.sh produces tags in format `main-abc1234-1707300000` that Flux ImagePolicy can sort alphabetically to find the latest image.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions workflow for automated builds</name>
  <files>.github/workflows/build-and-push.yml</files>
  <action>
    Create `.github/workflows/build-and-push.yml`:

    ```yaml
    name: Build and Push Images

    on:
      push:
        branches: [master]
        paths-ignore:
          - '**.md'
          - '.planning/**'
          - 'flux/**'

    jobs:
      build:
        runs-on: self-hosted
        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Load production environment
            run: |
              if [ ! -f .env.production ]; then
                echo "Error: .env.production not found on runner"
                exit 1
              fi

          - name: Build and push images
            run: ./scripts/build-and-push.sh all
    ```

    Key design decisions:
    - `self-hosted` runner: Must be on LAN for Harbor access at 192.168.0.40:5000. Cloud runners cannot reach the local Harbor registry.
    - `paths-ignore`: Skip builds for documentation, planning docs, and Flux manifest changes (Flux manifest changes are written by Flux automation, not code changes).
    - `.env.production` is pre-configured on the runner (NOT in git). The workflow checks it exists.
    - No need for Docker login step: Harbor at 192.168.0.40:5000 uses HTTP without auth for push (homelab setup).
    - The build script handles platform detection (ARM64/AMD64), tagging, and push.
    - No caching step: self-hosted runner preserves Docker cache between runs.

    Create the directory `.github/workflows/` if it does not exist.
  </action>
  <verify>
    Verify file exists: `ls -la .github/workflows/build-and-push.yml`
    Verify YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/build-and-push.yml'))"` (or `yq` if available)
    Grep for key elements: `grep 'self-hosted' .github/workflows/build-and-push.yml` and `grep 'build-and-push.sh' .github/workflows/build-and-push.yml`
  </verify>
  <done>
    GitHub Actions workflow triggers on push to master, runs on self-hosted runner, executes build-and-push.sh to build and push images with sortable tags to Harbor.
  </done>
</task>

</tasks>

<verification>
- `bash -n scripts/build-and-push.sh` passes (no syntax errors)
- `grep 'IMAGE_TAG' scripts/build-and-push.sh` shows sortable tag pattern
- `.github/workflows/build-and-push.yml` exists with valid YAML
- Workflow references `self-hosted` runner and `build-and-push.sh`
- Tag format matches `main-[sha]-[timestamp]` pattern expected by Flux ImagePolicy
</verification>

<success_criteria>
- build-and-push.sh tags images as `main-abc1234-1707300000` instead of bare `abc1234`
- GitHub Actions workflow file exists and will trigger on master push
- Both files pass syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/06-gitops-with-flux/06-01-SUMMARY.md`
</output>
