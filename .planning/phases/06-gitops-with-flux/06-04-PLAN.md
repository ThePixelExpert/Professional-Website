---
phase: 06-gitops-with-flux
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - flux/clusters/production/sealed-secrets/harbor-credentials.yaml
  - flux/clusters/production/sealed-secrets/vm-ssh-key.yaml
  - flux/clusters/production/sealed-secrets/kustomization.yaml
  - scripts/seal-secrets.sh
autonomous: true

must_haves:
  truths:
    - "Secret templates exist for Harbor credentials and VM SSH key"
    - "A script generates SealedSecret manifests from user-provided values"
    - "Plaintext secrets are never committed to git"
  artifacts:
    - path: "flux/clusters/production/sealed-secrets/harbor-credentials.yaml"
      provides: "Template/placeholder for Harbor registry credentials SealedSecret"
      contains: "SealedSecret"
    - path: "flux/clusters/production/sealed-secrets/vm-ssh-key.yaml"
      provides: "Template/placeholder for VM SSH key SealedSecret"
      contains: "SealedSecret"
    - path: "scripts/seal-secrets.sh"
      provides: "Script to generate SealedSecrets from user inputs"
      contains: "kubeseal"
  key_links:
    - from: "scripts/seal-secrets.sh"
      to: "flux/clusters/production/sealed-secrets/"
      via: "Generates sealed secret YAML files"
      pattern: "kubeseal"
    - from: "flux/clusters/production/sealed-secrets/vm-ssh-key.yaml"
      to: "flux/clusters/production/backend/deploy-job.yaml"
      via: "Job mounts secretName: vm-ssh-key"
      pattern: "vm-ssh-key"
---

<objective>
Create Sealed Secrets templates and a helper script for encrypting secrets that Flux needs.

Purpose: Flux syncs from git, so secrets cannot be stored in plaintext. Sealed Secrets encrypts them with the cluster's public key so only the cluster can decrypt. Two secrets are needed: Harbor registry credentials (for pulling images) and the VM SSH key (for the backend deploy Job). The helper script makes it easy for the user to generate the sealed versions.

Output: Placeholder SealedSecret manifests, a Kustomization referencing them, and a helper script for generating real sealed secrets.
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-gitops-with-flux/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SealedSecret placeholder manifests and Kustomization</name>
  <files>
    flux/clusters/production/sealed-secrets/harbor-credentials.yaml
    flux/clusters/production/sealed-secrets/vm-ssh-key.yaml
    flux/clusters/production/sealed-secrets/kustomization.yaml
  </files>
  <action>
    Create placeholder SealedSecret manifests. These are NOT the actual sealed secrets (those require the cluster's public key). These are placeholder files showing the expected structure that will be replaced by real sealed secrets during bootstrap.

    1. **flux/clusters/production/sealed-secrets/harbor-credentials.yaml:**
    ```yaml
    # PLACEHOLDER - Replace with actual SealedSecret generated by scripts/seal-secrets.sh
    # This file will be overwritten with encrypted values after Sealed Secrets controller is installed.
    #
    # Required by: ImageRepository CRDs (to authenticate with Harbor registry)
    # Secret name: harbor-credentials
    # Namespace: flux-system
    # Keys: .dockerconfigjson (Docker config with Harbor auth)
    ---
    apiVersion: bitnami.com/v1alpha1
    kind: SealedSecret
    metadata:
      name: harbor-credentials
      namespace: flux-system
    spec:
      encryptedData:
        .dockerconfigjson: PLACEHOLDER_RUN_SEAL_SECRETS_SH
      template:
        metadata:
          name: harbor-credentials
          namespace: flux-system
        type: kubernetes.io/dockerconfigjson
    ```

    2. **flux/clusters/production/sealed-secrets/vm-ssh-key.yaml:**
    ```yaml
    # PLACEHOLDER - Replace with actual SealedSecret generated by scripts/seal-secrets.sh
    # This file will be overwritten with encrypted values after Sealed Secrets controller is installed.
    #
    # Required by: backend deploy Job (mounts SSH key to connect to Proxmox VM)
    # Secret name: vm-ssh-key
    # Namespace: website
    # Keys: id_ed25519 (SSH private key for ubuntu@192.168.0.50)
    ---
    apiVersion: bitnami.com/v1alpha1
    kind: SealedSecret
    metadata:
      name: vm-ssh-key
      namespace: website
    spec:
      encryptedData:
        id_ed25519: PLACEHOLDER_RUN_SEAL_SECRETS_SH
      template:
        metadata:
          name: vm-ssh-key
          namespace: website
        type: Opaque
    ```

    3. **flux/clusters/production/sealed-secrets/kustomization.yaml:**
    ```yaml
    apiVersion: kustomize.config.k8s.io/v1beta1
    kind: Kustomization
    resources:
      - harbor-credentials.yaml
      - vm-ssh-key.yaml
    ```
  </action>
  <verify>
    Verify files exist: `ls flux/clusters/production/sealed-secrets/`
    Verify SealedSecret kind: `grep 'kind: SealedSecret' flux/clusters/production/sealed-secrets/harbor-credentials.yaml`
    Verify correct namespaces: `grep 'namespace: flux-system' flux/clusters/production/sealed-secrets/harbor-credentials.yaml` and `grep 'namespace: website' flux/clusters/production/sealed-secrets/vm-ssh-key.yaml`
    Verify kustomization references both: `grep -c '.yaml' flux/clusters/production/sealed-secrets/kustomization.yaml` should be 2
  </verify>
  <done>
    SealedSecret placeholder manifests exist for harbor-credentials (flux-system namespace, dockerconfigjson type) and vm-ssh-key (website namespace, Opaque type). Kustomization references both. Placeholders clearly marked as needing replacement.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create seal-secrets.sh helper script</name>
  <files>scripts/seal-secrets.sh</files>
  <action>
    Create `scripts/seal-secrets.sh` that generates real SealedSecret manifests from user-provided values. This script runs AFTER the Sealed Secrets controller is installed on the cluster (it needs the cluster's public key).

    ```bash
    #!/bin/bash
    set -euo pipefail

    # seal-secrets.sh - Generate SealedSecret manifests for Flux GitOps
    #
    # Prerequisites:
    #   - kubeseal CLI installed (see docs/FLUX_SETUP.md)
    #   - Sealed Secrets controller running on k3s cluster
    #   - kubectl configured to access k3s cluster
    #
    # Usage: ./scripts/seal-secrets.sh

    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
    SEALED_DIR="${REPO_ROOT}/flux/clusters/production/sealed-secrets"

    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'

    echo -e "${GREEN}=== Seal Secrets for Flux ===${NC}"
    echo ""

    # Check prerequisites
    if ! command -v kubeseal &>/dev/null; then
      echo -e "${RED}Error: kubeseal is not installed${NC}"
      echo "Install it:"
      echo "  KUBESEAL_VERSION='0.24.0'"
      echo "  wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v\${KUBESEAL_VERSION}/kubeseal-\${KUBESEAL_VERSION}-linux-arm64.tar.gz"
      echo "  tar -xvzf kubeseal-*.tar.gz kubeseal"
      echo "  sudo install -m 755 kubeseal /usr/local/bin/kubeseal"
      exit 1
    fi

    if ! kubectl get pods -n flux-system -l app.kubernetes.io/name=sealed-secrets-controller &>/dev/null 2>&1; then
      echo -e "${YELLOW}Warning: Cannot verify Sealed Secrets controller is running${NC}"
      echo "Make sure the controller is installed before sealing secrets."
      echo ""
    fi

    # --- Harbor Credentials ---
    echo -e "${YELLOW}--- Harbor Registry Credentials ---${NC}"
    echo "Harbor registry: 192.168.0.40:5000"

    read -p "Harbor username [admin]: " HARBOR_USER
    HARBOR_USER=${HARBOR_USER:-admin}

    read -sp "Harbor password: " HARBOR_PASS
    echo ""

    if [ -z "$HARBOR_PASS" ]; then
      echo -e "${RED}Error: Harbor password cannot be empty${NC}"
      exit 1
    fi

    echo -e "${YELLOW}Creating Harbor credentials SealedSecret...${NC}"

    kubectl create secret docker-registry harbor-credentials \
      --namespace=flux-system \
      --docker-server=192.168.0.40:5000 \
      --docker-username="${HARBOR_USER}" \
      --docker-password="${HARBOR_PASS}" \
      --dry-run=client -o yaml | \
      kubeseal --format yaml --controller-namespace flux-system > "${SEALED_DIR}/harbor-credentials.yaml"

    echo -e "${GREEN}Sealed: ${SEALED_DIR}/harbor-credentials.yaml${NC}"
    echo ""

    # --- VM SSH Key ---
    echo -e "${YELLOW}--- VM SSH Key ---${NC}"
    echo "Target: ubuntu@192.168.0.50 (Proxmox VM)"

    DEFAULT_KEY="$HOME/.ssh/id_ed25519"
    read -p "Path to SSH private key [${DEFAULT_KEY}]: " SSH_KEY_PATH
    SSH_KEY_PATH=${SSH_KEY_PATH:-$DEFAULT_KEY}

    if [ ! -f "$SSH_KEY_PATH" ]; then
      echo -e "${RED}Error: SSH key not found at ${SSH_KEY_PATH}${NC}"
      exit 1
    fi

    echo -e "${YELLOW}Creating VM SSH key SealedSecret...${NC}"

    kubectl create secret generic vm-ssh-key \
      --namespace=website \
      --from-file=id_ed25519="${SSH_KEY_PATH}" \
      --dry-run=client -o yaml | \
      kubeseal --format yaml --controller-namespace flux-system > "${SEALED_DIR}/vm-ssh-key.yaml"

    echo -e "${GREEN}Sealed: ${SEALED_DIR}/vm-ssh-key.yaml${NC}"
    echo ""

    # --- Summary ---
    echo -e "${GREEN}=== Secrets Sealed ===${NC}"
    echo "Files updated:"
    echo "  ${SEALED_DIR}/harbor-credentials.yaml"
    echo "  ${SEALED_DIR}/vm-ssh-key.yaml"
    echo ""
    echo "Next steps:"
    echo "  git add flux/clusters/production/sealed-secrets/"
    echo "  git commit -m 'chore: seal secrets for Flux'"
    echo "  git push"
    echo ""
    echo "Flux will automatically decrypt and create the Kubernetes Secrets."
    ```

    Make the script executable: `chmod +x scripts/seal-secrets.sh`

    Key design decisions:
    - Interactive prompts for credentials (not command-line args, to avoid secrets in shell history)
    - Defaults for common values (admin user, ~/.ssh/id_ed25519)
    - Uses `kubectl create secret --dry-run=client -o yaml | kubeseal` pattern from Sealed Secrets docs
    - Overwrites the placeholder files in-place
    - Harbor secret in flux-system namespace (where ImageRepository CRDs live)
    - VM SSH key in website namespace (where the deploy Job runs)
  </action>
  <verify>
    Verify script exists and is executable: `ls -la scripts/seal-secrets.sh`
    Verify syntax: `bash -n scripts/seal-secrets.sh`
    Verify kubeseal usage: `grep 'kubeseal' scripts/seal-secrets.sh`
    Verify both secrets generated: `grep -c 'harbor-credentials\|vm-ssh-key' scripts/seal-secrets.sh` should be multiple
  </verify>
  <done>
    seal-secrets.sh interactively collects Harbor credentials and SSH key path, generates SealedSecret manifests using kubeseal, and writes them to the flux sealed-secrets directory. Script is executable and passes syntax check.
  </done>
</task>

</tasks>

<verification>
- `ls flux/clusters/production/sealed-secrets/` shows 3 files
- `ls -la scripts/seal-secrets.sh` shows executable permissions
- `bash -n scripts/seal-secrets.sh` passes
- Placeholder manifests use correct SealedSecret API and namespaces
- seal-secrets.sh uses kubeseal to encrypt secrets
</verification>

<success_criteria>
- SealedSecret placeholders exist for harbor-credentials and vm-ssh-key
- Helper script generates real sealed secrets interactively
- Namespaces are correct (flux-system for Harbor, website for SSH key)
- No plaintext secrets in any committed files
</success_criteria>

<output>
After completion, create `.planning/phases/06-gitops-with-flux/06-04-SUMMARY.md`
</output>
