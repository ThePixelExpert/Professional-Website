---
phase: 06-gitops-with-flux
plan: 05
type: execute
wave: 2
depends_on: ["06-02", "06-03"]
files_modified:
  - flux/clusters/production/image-automation/image-repositories.yaml
  - flux/clusters/production/image-automation/image-policies.yaml
  - flux/clusters/production/image-automation/image-update-automation.yaml
  - flux/clusters/production/image-automation/kustomization.yaml
autonomous: true

must_haves:
  truths:
    - "Flux polls Harbor registry for new frontend and backend images every 1 minute"
    - "ImagePolicy selects the latest image by alphabetical tag sorting (timestamp makes newest = highest)"
    - "ImageUpdateAutomation writes new tags back to git by updating setter comments in deployment and docker-compose files"
  artifacts:
    - path: "flux/clusters/production/image-automation/image-repositories.yaml"
      provides: "ImageRepository CRDs polling Harbor for frontend and backend images"
      contains: "192.168.0.40:5000"
    - path: "flux/clusters/production/image-automation/image-policies.yaml"
      provides: "ImagePolicy CRDs selecting latest tag by alphabetical sort"
      contains: "alphabetical"
    - path: "flux/clusters/production/image-automation/image-update-automation.yaml"
      provides: "ImageUpdateAutomation CRD writing tags back to git"
      contains: "Setters"
  key_links:
    - from: "flux/clusters/production/image-automation/image-repositories.yaml"
      to: "192.168.0.40:5000"
      via: "polls Harbor registry for image tags"
      pattern: "192\\.168\\.0\\.40:5000"
    - from: "flux/clusters/production/image-automation/image-update-automation.yaml"
      to: "flux/clusters/production"
      via: "updates YAML files with setter strategy"
      pattern: "path.*flux/clusters/production"
    - from: "flux/clusters/production/image-automation/image-policies.yaml"
      to: "flux/clusters/production/image-automation/image-repositories.yaml"
      via: "imageRepositoryRef references frontend/backend ImageRepository"
      pattern: "imageRepositoryRef"
---

<objective>
Create Flux image automation CRDs: ImageRepository (polls Harbor), ImagePolicy (selects latest tag), and ImageUpdateAutomation (writes tags to git).

Purpose: This is the core of the GitOps automation loop. ImageRepository polls Harbor every minute for new image tags. ImagePolicy uses alphabetical sorting to select the latest tag (the timestamp component in `main-abc1234-1707300000` ensures newest = alphabetically highest). ImageUpdateAutomation finds Flux setter comments in YAML files and updates the image tag, then commits and pushes to git. Flux then reconciles the updated manifests, deploying the new images.

Output: Complete image automation CRDs under flux/clusters/production/image-automation/.
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-gitops-with-flux/06-RESEARCH.md
@.planning/phases/06-gitops-with-flux/06-02-SUMMARY.md
@.planning/phases/06-gitops-with-flux/06-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ImageRepository and ImagePolicy CRDs</name>
  <files>
    flux/clusters/production/image-automation/image-repositories.yaml
    flux/clusters/production/image-automation/image-policies.yaml
  </files>
  <action>
    Create `flux/clusters/production/image-automation/` directory with the CRDs.

    1. **flux/clusters/production/image-automation/image-repositories.yaml:**
    ```yaml
    # ImageRepository CRDs - Poll Harbor registry for new image tags
    ---
    apiVersion: image.toolkit.fluxcd.io/v1beta2
    kind: ImageRepository
    metadata:
      name: frontend
      namespace: flux-system
    spec:
      image: 192.168.0.40:5000/frontend
      interval: 1m0s
      secretRef:
        name: harbor-credentials
      insecure: true  # Harbor runs HTTP in homelab (no TLS)
    ---
    apiVersion: image.toolkit.fluxcd.io/v1beta2
    kind: ImageRepository
    metadata:
      name: backend
      namespace: flux-system
    spec:
      image: 192.168.0.40:5000/backend
      interval: 1m0s
      secretRef:
        name: harbor-credentials
      insecure: true  # Harbor runs HTTP in homelab (no TLS)
    ```

    Key config:
    - `insecure: true` is REQUIRED because Harbor at 192.168.0.40:5000 uses HTTP (no TLS in homelab)
    - `interval: 1m0s` polls every minute for new tags
    - `secretRef` references the harbor-credentials SealedSecret (decrypted by Sealed Secrets controller)
    - Both CRDs in flux-system namespace (standard for image automation)

    2. **flux/clusters/production/image-automation/image-policies.yaml:**
    ```yaml
    # ImagePolicy CRDs - Select latest image tag using alphabetical sorting
    ---
    apiVersion: image.toolkit.fluxcd.io/v1beta2
    kind: ImagePolicy
    metadata:
      name: frontend
      namespace: flux-system
    spec:
      imageRepositoryRef:
        name: frontend
      policy:
        alphabetical:
          order: asc
      filterTags:
        pattern: '^main-[a-f0-9]{7}-[0-9]{10}$'
        extract: '$0'
    ---
    apiVersion: image.toolkit.fluxcd.io/v1beta2
    kind: ImagePolicy
    metadata:
      name: backend
      namespace: flux-system
    spec:
      imageRepositoryRef:
        name: backend
      policy:
        alphabetical:
          order: asc
      filterTags:
        pattern: '^main-[a-f0-9]{7}-[0-9]{10}$'
        extract: '$0'
    ```

    Key config:
    - `alphabetical.order: asc` means highest value wins (latest timestamp)
    - `filterTags.pattern` matches ONLY our sortable tag format `main-abc1234-1707300000`, ignoring `latest` or any other tags
    - `extract: '$0'` uses the full matched tag (no extraction needed since the full tag IS the sortable value)
    - ImagePolicy names MUST match the setter comment references: `flux-system:frontend` and `flux-system:backend`
  </action>
  <verify>
    Verify files exist: `ls flux/clusters/production/image-automation/`
    Verify Harbor URL: `grep '192.168.0.40:5000' flux/clusters/production/image-automation/image-repositories.yaml`
    Verify insecure flag: `grep 'insecure: true' flux/clusters/production/image-automation/image-repositories.yaml`
    Verify alphabetical policy: `grep 'alphabetical' flux/clusters/production/image-automation/image-policies.yaml`
    Verify tag filter: `grep 'main-' flux/clusters/production/image-automation/image-policies.yaml`
    Validate YAML: `python3 -c "import yaml; [list(yaml.safe_load_all(open(f))) for f in ['flux/clusters/production/image-automation/image-repositories.yaml', 'flux/clusters/production/image-automation/image-policies.yaml']]"`
  </verify>
  <done>
    ImageRepository CRDs poll Harbor every minute for frontend and backend images with insecure flag for HTTP. ImagePolicy CRDs select latest tag using alphabetical sorting with filter for main-SHA-TIMESTAMP format.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ImageUpdateAutomation CRD and Kustomization</name>
  <files>
    flux/clusters/production/image-automation/image-update-automation.yaml
    flux/clusters/production/image-automation/kustomization.yaml
  </files>
  <action>
    1. **flux/clusters/production/image-automation/image-update-automation.yaml:**
    ```yaml
    # ImageUpdateAutomation - Writes new image tags to git via setter comments
    ---
    apiVersion: image.toolkit.fluxcd.io/v1beta2
    kind: ImageUpdateAutomation
    metadata:
      name: flux-system
      namespace: flux-system
    spec:
      interval: 1m0s
      sourceRef:
        kind: GitRepository
        name: flux-system
      git:
        checkout:
          ref:
            branch: master
        commit:
          author:
            email: fluxcdbot@users.noreply.github.com
            name: fluxcdbot
          messageTemplate: |
            chore(flux): update image tags

            Automation: {{ range .Changed.Objects }}{{ .Key.Name }}: {{ .NewValue }}
            {{ end }}
        push:
          branch: master
      update:
        path: ./flux/clusters/production
        strategy: Setters
    ```

    Key config:
    - `sourceRef` references the `flux-system` GitRepository (created by bootstrap)
    - `git.checkout.ref.branch: master` matches the project's main branch
    - `git.push.branch: master` pushes updates back to master (requires read-write deploy key from bootstrap)
    - `update.path: ./flux/clusters/production` scans ALL files under this path for setter comments. This includes both `frontend/deployment.yaml` and `backend/docker-compose.backend.yml`
    - `update.strategy: Setters` looks for `{"$imagepolicy": "..."}` comments and updates the image value on that line
    - `messageTemplate` uses Go template to list which images were updated in the commit message
    - Commit author is fluxcdbot (standard convention)

    IMPORTANT: The `update.path` MUST be `./flux/clusters/production` (not just `./flux`). This scopes the setter scan to only production manifests, preventing accidental updates to base/ or other cluster configs.

    2. **flux/clusters/production/image-automation/kustomization.yaml:**
    ```yaml
    apiVersion: kustomize.config.k8s.io/v1beta1
    kind: Kustomization
    resources:
      - image-repositories.yaml
      - image-policies.yaml
      - image-update-automation.yaml
    ```
  </action>
  <verify>
    Verify files exist: `ls flux/clusters/production/image-automation/`
    Verify Setters strategy: `grep 'Setters' flux/clusters/production/image-automation/image-update-automation.yaml`
    Verify path scope: `grep 'path.*flux/clusters/production' flux/clusters/production/image-automation/image-update-automation.yaml`
    Verify master branch: `grep 'branch: master' flux/clusters/production/image-automation/image-update-automation.yaml`
    Verify kustomization lists all 3 resources: `grep -c '.yaml' flux/clusters/production/image-automation/kustomization.yaml` should be 3
    Validate YAML: `python3 -c "import yaml; [yaml.safe_load(open(f)) for f in ['flux/clusters/production/image-automation/image-update-automation.yaml', 'flux/clusters/production/image-automation/kustomization.yaml']]"`
  </verify>
  <done>
    ImageUpdateAutomation scans flux/clusters/production/ for setter comments, updates image tags when ImagePolicy selects a new version, commits to master with descriptive message, and pushes. Kustomization references all 3 image automation CRDs.
  </done>
</task>

</tasks>

<verification>
- `ls flux/clusters/production/image-automation/` shows 4 files
- ImageRepository CRDs poll Harbor with insecure:true
- ImagePolicy CRDs use alphabetical sorting with tag filter
- ImageUpdateAutomation targets master branch with Setters strategy
- All YAML files parse correctly (multi-document files handled)
- CRD names match setter comment references (flux-system:frontend, flux-system:backend)
</verification>

<success_criteria>
- Complete image automation pipeline: poll Harbor -> select latest tag -> update git -> Flux reconciles
- Tag filter matches sortable format from build-and-push.sh
- Update path scoped to flux/clusters/production/
- All CRDs in flux-system namespace with correct API versions
</success_criteria>

<output>
After completion, create `.planning/phases/06-gitops-with-flux/06-05-SUMMARY.md`
</output>
