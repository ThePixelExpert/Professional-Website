---
phase: 06-gitops-with-flux
plan: 06
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03", "06-04", "06-05"]
files_modified:
  - flux/clusters/production/flux-kustomization.yaml
  - scripts/flux-bootstrap.sh
  - docs/FLUX_SETUP.md
autonomous: false

user_setup:
  - service: github
    why: "Flux bootstrap requires GitHub personal access token for deploy key creation"
    env_vars:
      - name: GITHUB_TOKEN
        source: "GitHub -> Settings -> Developer settings -> Personal access tokens -> Generate (repo scope)"
  - service: k3s-cluster
    why: "Flux bootstrap and Sealed Secrets install require kubectl access to k3s cluster"
    dashboard_config:
      - task: "Ensure kubectl is configured to access k3s cluster"
        location: "Copy kubeconfig from Pi: scp pi@192.168.0.40:~/.kube/config ~/.kube/config"
  - service: github-actions-runner
    why: "Self-hosted runner must be registered on Proxmox VM for CI builds"
    dashboard_config:
      - task: "Register self-hosted GitHub Actions runner"
        location: "GitHub repo -> Settings -> Actions -> Runners -> New self-hosted runner"

must_haves:
  truths:
    - "Flux Kustomization CRDs define the reconciliation order: sealed-secrets -> frontend -> ingress -> image-automation -> backend"
    - "Bootstrap script installs Flux with image automation controllers and Sealed Secrets"
    - "Setup documentation covers end-to-end: prerequisites, bootstrap, secret sealing, verification, rollback"
  artifacts:
    - path: "flux/clusters/production/flux-kustomization.yaml"
      provides: "Flux Kustomization CRDs defining reconciliation targets and order"
      contains: "dependsOn"
    - path: "scripts/flux-bootstrap.sh"
      provides: "Automated bootstrap script for Flux + Sealed Secrets installation"
      contains: "flux bootstrap"
    - path: "docs/FLUX_SETUP.md"
      provides: "Complete setup and operations guide"
      contains: "Bootstrap"
  key_links:
    - from: "flux/clusters/production/flux-kustomization.yaml"
      to: "flux/clusters/production/frontend/"
      via: "Kustomization path reference"
      pattern: "path.*frontend"
    - from: "flux/clusters/production/flux-kustomization.yaml"
      to: "flux/clusters/production/backend/"
      via: "Kustomization path reference with dependsOn frontend"
      pattern: "path.*backend"
    - from: "scripts/flux-bootstrap.sh"
      to: "flux/clusters/production/"
      via: "Bootstrap --path flag points to Flux directory"
      pattern: "flux/clusters/production"
---

<objective>
Create Flux Kustomization CRDs (reconciliation order), bootstrap script, and setup documentation.

Purpose: This plan ties everything together. The Flux Kustomization CRDs tell Flux WHAT to reconcile and in WHAT ORDER (sealed-secrets first, then frontend, then backend which depends on frontend health). The bootstrap script automates the one-time Flux installation. The documentation covers the complete lifecycle: setup, day-to-day operation, rollback procedures, and troubleshooting.

Output: Flux reconciliation config, bootstrap automation script, comprehensive setup guide.
</objective>

<execution_context>
@/home/logan/.claude/get-shit-done/workflows/execute-plan.md
@/home/logan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-gitops-with-flux/06-RESEARCH.md
@.planning/phases/06-gitops-with-flux/06-CONTEXT.md
@.planning/phases/06-gitops-with-flux/06-01-SUMMARY.md
@.planning/phases/06-gitops-with-flux/06-02-SUMMARY.md
@.planning/phases/06-gitops-with-flux/06-03-SUMMARY.md
@.planning/phases/06-gitops-with-flux/06-04-SUMMARY.md
@.planning/phases/06-gitops-with-flux/06-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Flux Kustomization CRDs for reconciliation order</name>
  <files>flux/clusters/production/flux-kustomization.yaml</files>
  <action>
    Create `flux/clusters/production/flux-kustomization.yaml` containing Flux Kustomization CRDs that define what Flux reconciles and in what order.

    These are Flux Kustomization CRDs (kustomize.toolkit.fluxcd.io), NOT kustomize.config Kustomization files. They tell Flux "reconcile this path from git" with dependency ordering.

    ```yaml
    # Flux Kustomization CRDs - Define reconciliation targets and order
    #
    # Reconciliation order (enforced by dependsOn):
    #   1. sealed-secrets (decrypt secrets first)
    #   2. frontend + ingress (parallel, no deps between them)
    #   3. image-automation (needs secrets for Harbor auth)
    #   4. backend (depends on frontend health - deploy frontend first)
    ---
    apiVersion: kustomize.toolkit.fluxcd.io/v1
    kind: Kustomization
    metadata:
      name: sealed-secrets
      namespace: flux-system
    spec:
      interval: 10m0s
      path: ./flux/clusters/production/sealed-secrets
      prune: true
      sourceRef:
        kind: GitRepository
        name: flux-system
      healthChecks:
        - apiVersion: bitnami.com/v1alpha1
          kind: SealedSecret
          name: harbor-credentials
          namespace: flux-system
        - apiVersion: bitnami.com/v1alpha1
          kind: SealedSecret
          name: vm-ssh-key
          namespace: website
    ---
    apiVersion: kustomize.toolkit.fluxcd.io/v1
    kind: Kustomization
    metadata:
      name: frontend
      namespace: flux-system
    spec:
      interval: 5m0s
      path: ./flux/clusters/production/frontend
      prune: true
      sourceRef:
        kind: GitRepository
        name: flux-system
      dependsOn:
        - name: sealed-secrets
      healthChecks:
        - apiVersion: apps/v1
          kind: Deployment
          name: frontend
          namespace: website
      timeout: 5m0s
    ---
    apiVersion: kustomize.toolkit.fluxcd.io/v1
    kind: Kustomization
    metadata:
      name: ingress
      namespace: flux-system
    spec:
      interval: 10m0s
      path: ./flux/clusters/production/ingress
      prune: true
      sourceRef:
        kind: GitRepository
        name: flux-system
      dependsOn:
        - name: frontend
    ---
    apiVersion: kustomize.toolkit.fluxcd.io/v1
    kind: Kustomization
    metadata:
      name: image-automation
      namespace: flux-system
    spec:
      interval: 10m0s
      path: ./flux/clusters/production/image-automation
      prune: true
      sourceRef:
        kind: GitRepository
        name: flux-system
      dependsOn:
        - name: sealed-secrets
    ---
    apiVersion: kustomize.toolkit.fluxcd.io/v1
    kind: Kustomization
    metadata:
      name: backend-deploy
      namespace: flux-system
    spec:
      interval: 5m0s
      path: ./flux/clusters/production/backend
      prune: true
      sourceRef:
        kind: GitRepository
        name: flux-system
      force: true
      dependsOn:
        - name: frontend
      timeout: 5m0s
    ```

    Key design decisions:
    - `sealed-secrets` first: All other resources need decrypted secrets
    - `frontend` depends on sealed-secrets: needs to be able to pull from Harbor
    - `ingress` depends on frontend: routing should only be active after frontend is healthy
    - `image-automation` depends on sealed-secrets: needs Harbor credentials to poll registry
    - `backend-deploy` depends on frontend: deploy frontend first, then backend (user's CONTEXT.md decision: "Frontend first, then backend")
    - `force: true` on backend-deploy: Forces Job recreation on each reconciliation (otherwise Kubernetes sees same Job name and skips)
    - `timeout: 5m0s` on frontend and backend: Matches user's 5-minute failure timeout from CONTEXT.md
    - `healthChecks` on frontend: Flux waits for Deployment to be healthy before marking Kustomization as ready
    - `prune: true` on all: Flux removes resources from cluster if they are removed from git
    - Different intervals: frontend/backend at 5m (active deployments), others at 10m (config that changes rarely)
  </action>
  <verify>
    Verify file exists: `ls flux/clusters/production/flux-kustomization.yaml`
    Verify all 5 Kustomizations: `grep 'kind: Kustomization' flux/clusters/production/flux-kustomization.yaml | wc -l` should be 5
    Verify dependsOn chain: `grep -A2 'dependsOn' flux/clusters/production/flux-kustomization.yaml`
    Verify force on backend: `grep 'force: true' flux/clusters/production/flux-kustomization.yaml`
    Verify paths: `grep 'path:' flux/clusters/production/flux-kustomization.yaml` should show 5 paths
    Validate YAML: `python3 -c "import yaml; list(yaml.safe_load_all(open('flux/clusters/production/flux-kustomization.yaml')))"`
  </verify>
  <done>
    5 Flux Kustomization CRDs define reconciliation order: sealed-secrets -> frontend + image-automation (parallel) -> ingress -> backend-deploy. Backend uses force:true for Job recreation. Frontend has health checks. 5-minute timeout matches user requirements.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create bootstrap script and setup documentation</name>
  <files>
    scripts/flux-bootstrap.sh
    docs/FLUX_SETUP.md
  </files>
  <action>
    1. **scripts/flux-bootstrap.sh:**

    Create a bootstrap script that installs Flux and Sealed Secrets on the k3s cluster:

    ```bash
    #!/bin/bash
    set -euo pipefail

    # flux-bootstrap.sh - One-time setup for Flux GitOps on k3s cluster
    #
    # Prerequisites:
    #   - kubectl configured for k3s cluster
    #   - GITHUB_TOKEN env var set (personal access token with 'repo' scope)
    #   - flux CLI installed (https://fluxcd.io/flux/installation/#install-the-flux-cli)
    #   - helm CLI installed
    #   - kubeseal CLI installed
    #
    # Usage: GITHUB_TOKEN=ghp_xxx ./scripts/flux-bootstrap.sh

    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'

    # Configuration - Update these for your setup
    GITHUB_USER="${GITHUB_USER:-}"
    GITHUB_REPO="${GITHUB_REPO:-Professional-Website}"

    echo -e "${GREEN}=== Flux GitOps Bootstrap ===${NC}"
    echo ""

    # --- Prerequisite Checks ---
    echo -e "${YELLOW}Checking prerequisites...${NC}"

    if [ -z "${GITHUB_TOKEN:-}" ]; then
      echo -e "${RED}Error: GITHUB_TOKEN not set${NC}"
      echo "Export a personal access token with 'repo' scope:"
      echo "  export GITHUB_TOKEN=ghp_xxxxxxxxxxxx"
      exit 1
    fi

    if [ -z "${GITHUB_USER}" ]; then
      echo -e "${RED}Error: GITHUB_USER not set${NC}"
      echo "Export your GitHub username:"
      echo "  export GITHUB_USER=yourusername"
      exit 1
    fi

    for cmd in flux kubectl helm kubeseal; do
      if ! command -v "$cmd" &>/dev/null; then
        echo -e "${RED}Error: $cmd is not installed${NC}"
        exit 1
      fi
    done

    echo -e "${GREEN}All prerequisites met${NC}"
    echo ""

    # --- Step 1: Flux Pre-flight Check ---
    echo -e "${YELLOW}Step 1: Running Flux pre-flight checks...${NC}"
    flux check --pre
    echo -e "${GREEN}Pre-flight checks passed${NC}"
    echo ""

    # --- Step 2: Bootstrap Flux ---
    echo -e "${YELLOW}Step 2: Bootstrapping Flux...${NC}"
    flux bootstrap github \
      --owner="${GITHUB_USER}" \
      --repository="${GITHUB_REPO}" \
      --branch=master \
      --path=flux/clusters/production \
      --components-extra=image-reflector-controller,image-automation-controller \
      --read-write-key \
      --personal

    echo -e "${GREEN}Flux bootstrapped successfully${NC}"
    echo ""

    # --- Step 3: Install Sealed Secrets ---
    echo -e "${YELLOW}Step 3: Installing Sealed Secrets controller...${NC}"
    helm repo add sealed-secrets https://bitnami-labs.github.io/sealed-secrets
    helm repo update

    helm install sealed-secrets sealed-secrets/sealed-secrets \
      --namespace flux-system \
      --set-string fullnameOverride=sealed-secrets-controller \
      --wait

    echo -e "${GREEN}Sealed Secrets controller installed${NC}"
    echo ""

    # --- Step 4: Verify Installation ---
    echo -e "${YELLOW}Step 4: Verifying installation...${NC}"
    flux check
    echo ""

    echo -e "${YELLOW}Flux controllers:${NC}"
    kubectl get pods -n flux-system
    echo ""

    echo -e "${YELLOW}Sealed Secrets controller:${NC}"
    kubectl get pods -n flux-system -l app.kubernetes.io/name=sealed-secrets
    echo ""

    # --- Step 5: Next Steps ---
    echo -e "${GREEN}=== Bootstrap Complete ===${NC}"
    echo ""
    echo "Next steps:"
    echo "  1. Seal secrets:  ./scripts/seal-secrets.sh"
    echo "  2. Commit sealed secrets:  git add flux/ && git commit -m 'chore: add sealed secrets' && git push"
    echo "  3. Verify Flux reconciliation:  flux get kustomizations"
    echo "  4. Watch image automation:  flux get image policy --all-namespaces"
    echo ""
    echo "See docs/FLUX_SETUP.md for full documentation."
    ```

    Make executable: `chmod +x scripts/flux-bootstrap.sh`

    2. **docs/FLUX_SETUP.md:**

    Create comprehensive setup and operations guide. Structure:

    **Quick Start** (experienced users):
    - 5 commands: install CLIs, export tokens, run bootstrap, seal secrets, push

    **Prerequisites**:
    - flux CLI installation (with ARM64 note for Pi)
    - helm CLI installation
    - kubeseal CLI installation (ARM64 binary URL)
    - kubectl access to k3s cluster
    - GitHub personal access token (repo scope)
    - Self-hosted GitHub Actions runner on Proxmox VM

    **Bootstrap** (step by step):
    - Run flux-bootstrap.sh
    - What it creates (flux-system namespace, controllers, deploy key)
    - Verify with `flux check`

    **Seal Secrets**:
    - Run seal-secrets.sh
    - Commit and push sealed secrets
    - Verify decryption with `kubectl get secrets`

    **Self-Hosted Runner Setup**:
    - Install GitHub Actions runner on Proxmox VM
    - Configure Docker and buildx for multi-arch builds
    - Register runner with GitHub repo

    **How It Works** (day-to-day):
    - The GitOps flow: push code -> GH Actions builds -> Flux detects new image -> updates git -> Flux deploys
    - Diagram of the flow

    **Verification Commands**:
    - `flux get kustomizations` - reconciliation status
    - `flux get image repository` - Harbor polling status
    - `flux get image policy` - selected tags
    - `kubectl get deploy -n website` - deployment status
    - `flux logs` - controller logs

    **Rollback Procedure**:
    - Manual rollback: `git revert HEAD && git push` (per CONTEXT.md: "Git revert for audit trail")
    - How to rollback both frontend and backend together
    - Verify rollback: `flux get kustomizations` shows healthy

    **Troubleshooting**:
    - Image not updating: check ImageRepository status, Harbor connectivity, tag format
    - Backend Job failing: check Job logs, SSH connectivity, VM health
    - Flux not reconciling: check source-controller logs, git connectivity
    - Sealed Secrets not decrypting: check controller logs, key rotation

    **Architecture Overview**:
    - Directory structure explanation
    - Which files Flux manages vs which are reference/manual

    Keep the doc concise but complete. Target 150-200 lines. No fluff.
  </action>
  <verify>
    Verify scripts: `ls -la scripts/flux-bootstrap.sh` (should be executable)
    Verify syntax: `bash -n scripts/flux-bootstrap.sh`
    Verify docs: `ls docs/FLUX_SETUP.md`
    Verify bootstrap command: `grep 'flux bootstrap' scripts/flux-bootstrap.sh`
    Verify sealed-secrets install: `grep 'helm install sealed-secrets' scripts/flux-bootstrap.sh`
    Verify doc sections: `grep '##' docs/FLUX_SETUP.md | head -20` should show key sections
  </verify>
  <done>
    Bootstrap script automates Flux + Sealed Secrets installation with prerequisite checks. FLUX_SETUP.md covers complete lifecycle: prerequisites, bootstrap, secret management, daily operations, rollback, and troubleshooting.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Flux GitOps configuration for the professional website:
    - Updated build-and-push.sh with sortable tags (main-SHA-TIMESTAMP)
    - GitHub Actions workflow for automated builds on push to master
    - Flux-managed frontend manifests with image setter comments
    - Flux-managed ingress with split-architecture routing
    - Backend deploy Job (SSH to Proxmox VM) with docker-compose setter comment
    - Sealed Secrets templates and seal-secrets.sh helper
    - Image automation CRDs (ImageRepository, ImagePolicy, ImageUpdateAutomation)
    - Flux Kustomization CRDs with dependency ordering
    - Bootstrap script (flux-bootstrap.sh)
    - Setup documentation (docs/FLUX_SETUP.md)
  </what-built>
  <how-to-verify>
    1. Review the flux/ directory structure:
       `find flux/ -type f | sort`
       Expected:
         flux/clusters/production/backend/deploy-job.yaml
         flux/clusters/production/backend/docker-compose.backend.yml
         flux/clusters/production/backend/kustomization.yaml
         flux/clusters/production/frontend/deployment.yaml
         flux/clusters/production/frontend/kustomization.yaml
         flux/clusters/production/frontend/namespace.yaml
         flux/clusters/production/frontend/service.yaml
         flux/clusters/production/image-automation/image-policies.yaml
         flux/clusters/production/image-automation/image-repositories.yaml
         flux/clusters/production/image-automation/image-update-automation.yaml
         flux/clusters/production/image-automation/kustomization.yaml
         flux/clusters/production/ingress/ingress.yaml
         flux/clusters/production/ingress/kustomization.yaml
         flux/clusters/production/sealed-secrets/harbor-credentials.yaml
         flux/clusters/production/sealed-secrets/kustomization.yaml
         flux/clusters/production/sealed-secrets/vm-ssh-key.yaml
         flux/clusters/production/flux-kustomization.yaml

    2. Verify setter comments exist in deployment files:
       `grep 'imagepolicy' flux/clusters/production/frontend/deployment.yaml flux/clusters/production/backend/docker-compose.backend.yml`

    3. Verify tag format in build script:
       `grep 'IMAGE_TAG' scripts/build-and-push.sh`

    4. Review docs/FLUX_SETUP.md for completeness

    5. Review scripts/flux-bootstrap.sh for correctness

    6. Spot-check: Does the reconciliation order in flux-kustomization.yaml match your expectation?
       (sealed-secrets first, then frontend, then backend after frontend health)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the configuration</resume-signal>
</task>

</tasks>

<verification>
- `find flux/ -type f | wc -l` shows 17 files (complete directory structure)
- `bash -n scripts/flux-bootstrap.sh` passes
- `bash -n scripts/seal-secrets.sh` passes (from plan 04)
- `docs/FLUX_SETUP.md` exists with all key sections
- All YAML files parse without errors
- Setter comments present in frontend deployment and backend docker-compose
- Flux Kustomization CRDs define correct dependency chain
</verification>

<success_criteria>
- Complete Flux directory structure under flux/clusters/production/
- Bootstrap script installs Flux + Sealed Secrets in one command
- Documentation covers setup, operations, rollback, and troubleshooting
- User approves the overall configuration at checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/06-gitops-with-flux/06-06-SUMMARY.md`
</output>
