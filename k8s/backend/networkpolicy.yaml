apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-egress-policy
  namespace: website
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
    - Egress
  egress:
    # Allow DNS resolution (kube-dns in kube-system)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow connection to Supabase on TrueNAS (API port 8000)
    - to:
        - ipBlock:
            cidr: 192.168.0.50/32
      ports:
        - protocol: TCP
          port: 8000

    # Allow connection to Supabase PostgreSQL (port 5432)
    - to:
        - ipBlock:
            cidr: 192.168.0.50/32
      ports:
        - protocol: TCP
          port: 5432

    # Allow SMTP for email (port 587)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 587

    # Allow HTTPS for Stripe API and other external services (port 443)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443

    # Allow HTTP for external services if needed (port 80)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 80
